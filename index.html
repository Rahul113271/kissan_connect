<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KisanConnect - Your Local RaituBazar</title>
    
    <style>
        /* 1. Base Styles & Global Utilities */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        :root {
            --color-primary: #10b981; /* Green */
            --color-primary-dark: #059669; /* Darker Green */
            --color-secondary: #8b5cf6; /* Purple */
            --color-background: #f8fafc; 
            --color-text-dark: #1f2937;
            --color-chat-user: #e0f2f1; /* Teal 50 for user */
            --color-chat-gemini: #f3f4f6; /* Gray 100 for AI */
            --color-danger: #ef4444; /* Red */
            --color-danger-dark: #dc2626; 
        }
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: var(--color-background); 
            color: var(--color-text-dark); 
            margin: 0; 
            padding: 0; 
            line-height: 1.5; 
        }
        .container { 
            max-width: 1280px; 
            margin: 0 auto; 
            padding: 0 1rem; 
        }
        .flex-col-center { 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
        }

        /* 2. Loading Indicator */
        #loadingIndicator { position: fixed; inset: 0; background-color: #f9f9f9; display: flex; align-items: center; justify-content: center; z-index: 1000; transition: opacity 0.5s; }
        .spinner { animation: spin 1s linear infinite; border-radius: 50%; height: 48px; width: 48px; border-bottom: 2px solid var(--color-primary-dark); }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* 3. LOGIN VIEW (Home Page) */
        #loginView { 
            min-height: 100vh; 
            background-color: #ecfdf5; /* Light Green Background */
            display: none; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; /* Center content vertically */
            padding: 2rem 1rem; 
        }
        
        .login-card {
            background-color: white;
            padding: 3rem;
            border-radius: 1rem;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 1000px; /* Wider card */
            text-align: center;
        }

        .login-card h1 {
            font-size: 2.5rem;
            font-weight: 800;
            color: var(--color-primary-dark);
            margin-bottom: 0.5rem;
        }
        
        .role-grid {
            display: grid;
            gap: 1.5rem;
            margin-top: 2rem;
            /* Changed from 3fr to 2fr layout */
            grid-template-columns: repeat(1, 1fr); 
        }

        @media (min-width: 768px) {
            /* 2 column layout on tablet/desktop */
            .role-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        /* Style adjustments for a 2-column grid */
        .role-card {
            padding: 1.5rem;
            border-radius: 0.75rem;
            border: 2px solid #e5e7eb;
            background-color: #f9fafb;
            cursor: pointer;
            text-align: center;
            box-shadow: 0 5px 10px -3px rgba(0, 0, 0, 0.05);
            transition: transform 0.3s, box-shadow 0.3s, background-color 0.3s;
        }
        .role-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 15px 25px -5px rgba(0, 0, 0, 0.15);
            background-color: white;
        }
        .role-card h3 {
            font-size: 1.5rem;
            font-weight: 700;
            margin-top: 0.5rem;
        }
        .role-card span {
            display: inline-block;
            margin-top: 1rem;
            padding: 0.5rem 1rem;
            border-radius: 9999px;
            font-size: 0.875rem;
            font-weight: 600;
            color: white;
            border: none;
        }
        .role-card .icon {
             font-size: 3rem; 
             margin-bottom: 0.5rem;
        }

        /* Role Button Specific Colors */
        .customer-card h3 { color: #2563eb; } 
        .customer-card span { background-color: #2563eb; }
        .customer-card .icon { color: #2563eb; }

        .farmer-card h3 { color: var(--color-primary-dark); } 
        .farmer-card span { background-color: var(--color-primary-dark); }
        .farmer-card .icon { color: var(--color-primary-dark); }
        
        /* Admin styles removed as role is not implemented */

        #authStatus {
            margin-top: 2rem;
            font-size: 0.9rem;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            border: 1px dashed #d1d5db;
        }


        /* 4. Main Application Layout */
        #mainApp { display: none; }
        header { background-color: white; box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1); position: sticky; top: 0; z-index: 50; }
        header nav { display: flex; justify-content: space-between; align-items: center; padding: 1rem 0; flex-wrap: wrap; gap: 1rem;}
        .logo { font-size: 1.875rem; font-weight: 800; color: var(--color-primary-dark); }
        .nav-info { display: flex; align-items: center; gap: 1rem; flex-wrap: wrap; }
        #roleDisplay { font-size: 0.875rem; font-weight: 500; color: #4b5563; background-color: #f3f4f6; padding: 0.25rem 0.75rem; border-radius: 9999px; text-transform: capitalize; }
        
        /* New Location Block Style */
        #locationBlock {
            display: flex;
            align-items: center;
            gap: 0.4rem;
            font-size: 0.875rem;
            font-weight: 600;
            color: #4b5563;
            padding: 0.25rem 0.75rem;
            border: 1px solid #d1fae5;
            border-radius: 9999px;
            background-color: #f0fff4;
            cursor: pointer;
            transition: background-color 0.15s;
        }
        #locationBlock:hover {
            background-color: #ecfdf5;
        }

        /* Sign Out Button Style */
        .signout-btn {
            background-color: var(--color-danger); 
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 9999px;
            font-weight: 600;
            cursor: pointer;
            border: none;
            transition: background-color 0.15s;
        }
        .signout-btn:hover {
            background-color: var(--color-danger-dark);
        }
        
        .nav-link { padding: 0.5rem 0.75rem; border-radius: 9999px; font-weight: 600; color: #4b5563; cursor: pointer; transition: background-color 0.15s, color 0.15s; display: flex; align-items: center; gap: 0.4rem; border: none; background: none;}
        .nav-link:hover { background-color: #f3f4f6; color: var(--color-primary-dark); }
        #cartButton { padding: 0.5rem; background-color: #d1fae5; color: var(--color-primary-dark); border-radius: 9999px; transition: background-color 0.15s; position: relative; border: none; cursor: pointer; }
        #cartButton:hover { background-color: #a7f3d0; }
        #cartCounter { position: absolute; top: -4px; right: -4px; background-color: var(--color-danger); color: white; font-size: 0.75rem; font-weight: 700; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; border-radius: 50%; }

        /* 5. Customer Market Hero */
        .hero-section { background-color: var(--color-primary-dark); color: white; padding: 5rem 0; text-align: center; }
        .hero-section h1 { font-size: 3rem; font-weight: 800; margin-bottom: 1rem; letter-spacing: -0.05em; }
        .hero-section p { font-size: 1.25rem; font-weight: 300; margin-bottom: 2rem; max-width: 48rem; margin: 0 auto 2rem auto; }
        .hero-buttons { display: flex; flex-direction: column; justify-content: center; gap: 1rem; }
        .hero-buttons button { border: none; font-weight: 700; padding: 0.75rem 2rem; border-radius: 9999px; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); transition: background-color 0.3s, transform 0.3s; cursor: pointer; width: 100%; }
        .shop-btn { background-color: #facc15; color: #064e3b; }
        .shop-btn:hover { background-color: #eab308; transform: scale(1.05); }
        .recipe-btn { background-color: var(--color-secondary); color: white; } /* Keep style for layout, but remove button */
        .recipe-btn:hover { background-color: #7c3aed; transform: scale(1.05); }
        @media (min-width: 640px) { .hero-section h1 { font-size: 3.75rem; } .hero-buttons { flex-direction: row; gap: 1rem; } .hero-buttons button { width: auto; } }
        
        /* 6. Product Grid & Filter */
        #products { padding: 4rem 0; background-color: white; }
        #products h2 { font-size: 2.25rem; font-weight: 700; text-align: center; color: var(--color-text-dark); margin-bottom: 3rem; }
        #filterBar { display: flex; flex-direction: column; gap: 1.5rem; padding: 1.5rem 1rem; margin-bottom: 2rem; background-color: #f0fff4; border-radius: 0.75rem; border: 1px solid #d1fae5; }
        #filterBar .filter-group { display: flex; flex-direction: column; gap: 0.5rem; }
        #filterBar label { font-weight: 600; color: var(--color-primary-dark); }
        #filterBar input[type="range"], #filterBar select { width: 100%; padding: 0.5rem; border: 1px solid #d1fae5; border-radius: 0.5rem; box-sizing: border-box; background-color: white; }
        #priceRangeValue { font-weight: 700; color: var(--color-danger); }
        @media (min-width: 768px) { #filterBar { flex-direction: row; justify-content: space-between; align-items: center; gap: 2rem; } #filterBar .filter-group { flex-direction: row; align-items: center; gap: 1rem; } #filterBar input[type="range"], #filterBar select { width: auto; min-width: 150px; } }
        #productGrid { display: grid; gap: 2rem; grid-template-columns: repeat(1, 1fr); }
        @media (min-width: 640px) { #productGrid { grid-template-columns: repeat(2, 1fr); } }
        @media (min-width: 1024px) { #productGrid { grid-template-columns: repeat(3, 1fr); } }
        @media (min-width: 1280px) { #productGrid { grid-template-columns: repeat(4, 1fr); } }

        /* Product Card */
        .product-card { background-color: white; border-radius: 0.75rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); overflow: hidden; border: 1px solid #f3f4f6; transition: box-shadow 0.3s; }
        .product-card:hover { box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
        .product-card img { width: 100%; height: 12rem; object-fit: cover; object-position: center; }
        .card-content { padding: 1.25rem; }
        .card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.5rem; }
        .card-header h3 { font-size: 1.25rem; font-weight: 700; color: #1f2937; }
        .freshness-tag { font-size: 0.75rem; font-weight: 600; color: var(--color-primary-dark); background-color: #ecfdf5; padding: 0.25rem 0.75rem; border-radius: 9999px; white-space: nowrap; }
        .price-tag { font-size: 1.5rem; font-weight: 800; color: var(--color-primary-dark); margin-bottom: 0.5rem; }
        .price-tag .unit { font-size: 0.875rem; font-weight: 400; color: #6b7280; }
        .seller-info { font-size: 0.875rem; color: #6b7280; margin-bottom: 0.25rem; }
        .location-info { font-size: 0.875rem; color: #6b7280; margin-bottom: 1rem; font-weight: 500; }
        .add-to-cart-btn { width: 100%; background-color: var(--color-primary-dark); color: white; padding: 0.75rem; border-radius: 0.75rem; border: none; font-weight: 600; font-size: 1.125rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); cursor: pointer; }
        .add-to-cart-btn:hover { background-color: #047857; transform: scale(1.01); }
        .optimize-btn.check-freshness { background-color: #2563eb; color: white; margin-bottom: 0.5rem; width: 100%; } /* Keep style for layout, but remove button */

        /* 7. Footer */
        footer { background-color: #1f2937; color: white; padding: 2.5rem 0; margin-top: 4rem; text-align: center; }
        footer p { color: #9ca3af; margin-bottom: 1rem; }
        footer a { color: #9ca3af; text-decoration: none; transition: color 0.15s; margin: 0 0.75rem; }
        footer a:hover { color: #34d399; }

        /* 8. Modals */
        .modal-backdrop { position: fixed; inset: 0; background-color: rgba(0, 0, 0, 0.5); display: none; align-items: center; justify-content: center; z-index: 50; }
        .modal-content { background-color: white; padding: 1.5rem; border-radius: 0.75rem; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); max-width: 24rem; width: 90%; transform: scale(0.95); opacity: 0; transition: transform 0.3s, opacity 0.3s; }
        .modal-btn { width: 100%; padding: 0.5rem; border-radius: 0.5rem; border: none; font-weight: 600; cursor: pointer; color: white; transition: background-color 0.15s; }
        .modal-btn.success { background-color: var(--color-primary-dark); }
        .modal-btn.llm-close { background-color: var(--color-secondary); }
        .modal-btn.cancel { background-color: #9ca3af; margin-top: 0.5rem; } 


        /* Location Modal Specific Styles */
        #locationModalContent { max-width: 400px; }
        #locationModalContent .option-card { border: 1px solid #d1fae5; padding: 1rem; margin-bottom: 0.75rem; border-radius: 0.5rem; cursor: pointer; transition: background-color 0.15s; }
        #locationModalContent .option-card:hover { background-color: #f0fff4; }
        #manualLocationInput { width: 100%; padding: 0.75rem; border: 1px solid #d1fae5; border-radius: 0.5rem; box-sizing: border-box; margin-top: 0.5rem; }
        .set-location-btn { background-color: #2563eb; color: white; padding: 0.75rem; border-radius: 0.5rem; border: none; font-weight: 600; cursor: pointer; margin-top: 0.5rem; }

        /* Login Form Modal Styles */
        #loginFormModalContent { max-width: 450px; }
        #loginFormModalContent h3 { font-size: 1.5rem; font-weight: 700; margin-bottom: 1rem; text-align: center; }
        /* NEW: Tab styles for login/register */
        .auth-tabs { display: flex; border-bottom: 1px solid #e5e7eb; margin-bottom: 1.5rem; }
        .auth-tab { flex: 1; text-align: center; padding: 0.75rem 0.5rem; font-weight: 600; color: #6b7280; cursor: pointer; border-bottom: 3px solid transparent; }
        .auth-tab.active { color: var(--color-primary-dark); border-bottom-color: var(--color-primary-dark); }
        
        #loginForm, #registerForm { display: none; } /* Hide both by default */
        #loginForm.active, #registerForm.active { display: block; } /* Show only active one */

        #loginForm label, #registerForm label { display: block; font-weight: 600; margin-bottom: 0.25rem; }
        #loginForm input, #registerForm input { width: 100%; padding: 0.75rem; border: 1px solid #d1fae5; border-radius: 0.5rem; box-sizing: border-box; margin-bottom: 1rem; }
        #loginForm button[type="submit"], #registerForm button[type="submit"] { background-color: var(--color-primary-dark); color: white; width: 100%; padding: 0.75rem; border: none; border-radius: 0.5rem; font-weight: 700; cursor: pointer; margin-top: 0.5rem; }
        
        /* Edit Product Modal Styles */
        #editProductModalContent { max-width: 600px; }
        #editProductForm .form-group { margin-bottom: 1rem; }
        #editProductForm label { display: block; font-weight: 600; margin-bottom: 0.25rem; color: #059669; }
        #editProductForm input, #editProductForm select { width: 100%; padding: 0.75rem; border: 1px solid #d1fae5; border-radius: 0.5rem; box-sizing: border-box; }
        #editProductForm button[type="submit"] { background-color: #facc15; color: #064e3b; width: 100%; margin-top: 1rem; }


        /* 9. Farmer View */
        #farmerView { padding: 2rem 1rem; min-height: 80vh; background-color: #f0fff4; }
        .farmer-form-card { background-color: white; padding: 2rem; border-radius: 0.75rem; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); max-width: 600px; margin: 2rem auto 4rem auto; }
        .form-group { margin-bottom: 1rem; }
        .form-group label { display: block; font-weight: 600; margin-bottom: 0.25rem; color: #059669; }
        .form-group input, .form-group select { width: 100%; padding: 0.75rem; border: 1px solid #d1fae5; border-radius: 0.5rem; box-sizing: border-box; }
        .submit-btn { width: 100%; background-color: #facc15; color: #064e3b; font-weight: 700; padding: 0.75rem; border-radius: 9999px; border: none; cursor: pointer; margin-top: 1.5rem; }
        #myListingsContainer { display: grid; gap: 1.5rem; grid-template-columns: repeat(1, 1fr); margin-top: 2rem; }
        @media (min-width: 640px) { #myListingsContainer { grid-template-columns: repeat(2, 1fr); } }
        @media (min-width: 1024px) { #myListingsContainer { grid-template-columns: repeat(3, 1fr); } } 
        .listing-card { background-color: white; padding: 1rem; border-radius: 0.5rem; box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1); border: 1px solid #d1fae5; display: flex; flex-direction: column; justify-content: space-between; }
        .listing-card h4 { font-size: 1.125rem; font-weight: 700; color: #1f2937; margin-bottom: 0.5rem; }
        .listing-card .listing-details { margin-bottom: 1rem; } 
        .listing-card .listing-buttons { display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-top: auto; } 
        .delete-btn { background-color: var(--color-danger); color: white; padding: 0.5rem; border-radius: 0.5rem; border: none; font-weight: 600; cursor: pointer; }
        .edit-btn { background-color: #2563eb; color: white; padding: 0.5rem; border-radius: 0.5rem; border: none; font-weight: 600; cursor: pointer; } 
        .optimize-btn { background-color: #facc15; color: #064e3b; padding: 0.5rem; border-radius: 0.5rem; border: none; font-weight: 600; cursor: pointer; grid-column: 1 / -1; margin-top: 0.5rem; } 


        /* 10. Cart View */
        #cartPage { padding: 4rem 1rem; min-height: 80vh; background-color: white; display: none; }
        #cartPage h2 { font-size: 2.25rem; font-weight: 700; color: var(--color-text-dark); margin-bottom: 2rem; }
        .cart-layout { display: flex; flex-direction: column; gap: 2rem; }
        @media (min-width: 1024px) { .cart-layout { flex-direction: row; align-items: flex-start; } .cart-summary { width: 350px; min-width: 300px; } }
        #cartItemsList { flex-grow: 1; }
        .cart-item { display: grid; grid-template-columns: auto 1fr auto auto auto; align-items: center; border-bottom: 1px solid #e5e7eb; padding: 1rem 0; gap: 1rem; } 
        .cart-item:last-child { border-bottom: none; }
        .item-details { display: flex; align-items: center; gap: 1rem; }
        .item-details img { width: 60px; height: 60px; object-fit: cover; border-radius: 0.5rem; }
        .item-name-unit { font-size: 1rem; font-weight: 600; }
        .item-price { font-size: 1rem; font-weight: 500; }
        .quantity-controls { display: flex; align-items: center; justify-content: center; gap: 0.5rem; }
        .quantity-btn { background: none; border: 1px solid #ccc; width: 28px; height: 28px; border-radius: 50%; cursor: pointer; font-size: 1.25rem; line-height: 1; padding: 0; }
        .quantity-display { font-weight: 700; min-width: 20px; text-align: center; }
        .remove-btn { background: none; border: none; color: var(--color-danger); cursor: pointer; font-size: 1.5rem; }
        .cart-summary { background-color: #f9f9f9; padding: 1.5rem; border-radius: 0.75rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); width: 100%; }
        .summary-row { display: flex; justify-content: space-between; margin-bottom: 0.75rem; padding-bottom: 0.5rem; border-bottom: 1px dashed #e5e7eb; font-size: 1rem; }
        .summary-row:last-of-type { border-bottom: none; margin-top: 1rem; padding-top: 1rem; font-size: 1.25rem; font-weight: 700; color: var(--color-primary-dark); }
        .checkout-btn { width: 100%; padding: 1rem; background-color: var(--color-secondary); color: white; border: none; border-radius: 0.5rem; font-weight: 700; cursor: pointer; margin-top: 1rem; }
        .empty-cart-message { text-align: center; padding: 3rem; background-color: #f0fff4; border-radius: 0.75rem; border: 1px dashed #d1fae5; color: #059669; font-size: 1.125rem; font-weight: 500; }

        /* 11. Orders Page (Customer) */
        #ordersPage { padding: 4rem 1rem; min-height: 80vh; background-color: var(--color-background); display: none; }
        #ordersPage h2 { font-size: 2.25rem; font-weight: 700; color: var(--color-text-dark); text-align: center; margin-bottom: 2rem; }
        .orders-header { max-width: 900px; margin: 0 auto 2rem auto; display: flex; justify-content: space-between; align-items: center; }
        .back-button { background: none; border: 1px solid #ccc; color: #4b5563; padding: 0.5rem 1rem; border-radius: 9999px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 0.4rem; }
        #ordersList { max-width: 900px; margin: 0 auto; display: flex; flex-direction: column; gap: 1.5rem; }
        .order-card { background-color: white; padding: 1.5rem; border-radius: 0.75rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); border: 1px solid #e5e7eb; }
        .order-header-card { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #d1fae5; padding-bottom: 0.75rem; margin-bottom: 0.75rem; }
        .order-id { font-size: 1rem; font-weight: 500; color: #6b7280; }
        .order-status { font-weight: 700; font-size: 1.125rem; } 
        .order-status.processing { color: #f59e0b; } /* Yellow for processing */
        .order-status.delivered { color: var(--color-primary-dark); } /* Green for delivered */
        .order-status.cancelled { color: var(--color-danger); } /* Red for cancelled */

        .order-details-summary { display: flex; justify-content: space-between; margin-top: 0.5rem; align-items: center; /* Align items vertically */ }
        .order-total { font-size: 1.25rem; font-weight: 800; color: #1f2937; }
        .order-delivery { font-size: 0.875rem; font-weight: 600; color: #4b5563; }
        .order-item-list { margin-top: 1rem; padding: 0.5rem 0; border-top: 1px dashed #f3f4f6; }
        /* NEW: Cancel Order Button Style */
        .cancel-order-btn {
            background-color: var(--color-danger);
            color: white;
            padding: 0.4rem 0.8rem;
            border-radius: 0.5rem;
            border: none;
            font-weight: 600;
            font-size: 0.875rem;
            cursor: pointer;
            transition: background-color 0.15s;
        }
        .cancel-order-btn:hover {
            background-color: var(--color-danger-dark);
        }
        .order-card-footer {
             margin-top: 1rem; 
             padding-top: 1rem; 
             border-top: 1px solid #e5e7eb; 
             display: flex; 
             justify-content: flex-end; 
         }

        /* 12. CHAT BOT STYLES */
        #chatContainer { position: fixed; bottom: 20px; right: 20px; z-index: 100; }
        #chatToggleBtn { background-color: var(--color-secondary); color: white; border: none; width: 60px; height: 60px; border-radius: 50%; font-size: 1.5rem; cursor: pointer; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3); transition: transform 0.2s; display: flex; align-items: center; justify-content: center; }
        #chatToggleBtn:hover { transform: scale(1.1); }
        #chatWindow { position: absolute; bottom: 80px; right: 0; width: 320px; height: 400px; background-color: white; border-radius: 0.75rem; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2); display: flex; flex-direction: column; overflow: hidden; transform: translateY(100%); opacity: 0; transition: transform 0.3s ease-out, opacity 0.3s ease-out; pointer-events: none; }
        #chatWindow.open { transform: translateY(0); opacity: 1; pointer-events: auto; }
        #chatHeader { background-color: var(--color-secondary); color: white; padding: 0.75rem 1rem; font-weight: 600; font-size: 1rem; display: flex; justify-content: space-between; align-items: center; }
        #chatMessages { flex-grow: 1; padding: 1rem; overflow-y: auto; background-color: #fcfcfc; }
        .chat-message { margin-bottom: 0.75rem; max-width: 85%; }
        .chat-message p { padding: 0.5rem 0.75rem; border-radius: 0.5rem; line-height: 1.4; font-size: 0.9rem; white-space: pre-wrap; }
        .user-message { margin-left: auto; text-align: right; }
        .user-message p { background-color: var(--color-chat-user); color: #064e3b; }
        .gemini-message { margin-right: auto; text-align: left; }
        .gemini-message p { background-color: var(--color-chat-gemini); color: var(--color-text-dark); border: 1px solid #e5e7eb; }
        #chatInputContainer { border-top: 1px solid #e5e7eb; padding: 0.5rem; display: flex; }
        #chatInput { flex-grow: 1; padding: 0.5rem; border: 1px solid #e5e7eb; border-radius: 0.5rem; margin-right: 0.5rem; }
        #chatSendBtn { background-color: var(--color-primary-dark); color: white; border: none; padding: 0.5rem 1rem; border-radius: 0.5rem; cursor: pointer; transition: background-color 0.2s; }
        #chatSendBtn:hover { background-color: var(--color-primary); }
        .chat-spinner { border: 4px solid rgba(0, 0, 0, 0.1); border-left-color: #8b5cf6; border-radius: 50%; width: 16px; height: 16px; animation: spin 1s linear infinite; margin-right: 8px; }

        /* 13. NEW: Farmer Orders Page */
        #farmerOrdersPage { padding: 4rem 1rem; min-height: 80vh; background-color: #f0fff4; display: none; }
        #farmerOrdersPage h2 { font-size: 2.25rem; font-weight: 700; color: var(--color-primary-dark); text-align: center; margin-bottom: 2rem; }
        #farmerOrdersList { max-width: 900px; margin: 0 auto; display: flex; flex-direction: column; gap: 1.5rem; }
        .farmer-order-item-card { background-color: white; padding: 1.5rem; border-radius: 0.75rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); border: 1px solid #e5e7eb; }
        .farmer-order-item-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #d1fae5; padding-bottom: 0.75rem; margin-bottom: 1rem; }
        .farmer-order-item-header h4 { font-size: 1.25rem; font-weight: 700; color: #1f2937; margin: 0; }
        .farmer-order-item-details p { margin: 0.25rem 0; font-size: 1rem; }

    </style>
</head>
<body class="antialiased">

    <!-- Global Loading Indicator -->
    <div id="loadingIndicator">
        <div class="flex-col-center">
            <div class="spinner"></div>
            <p style="margin-top: 1rem; font-size: 1.125rem; color: #059669; font-weight: 600;">Connecting to KisanConnect...</p>
        </div>
    </div>

    <!-- 1. LOGIN VIEW (Role Selection) -->
    <section id="loginView" class="login-page">
        <div class="login-card">
            <h1>Welcome to KisanConnect</h1>
            <p style="font-size: 1.25rem; color: #4b5563; margin-bottom: 2.5rem;">Select your role to proceed to the RaituBazar interface.</p>
            
            <div class="role-grid">
                
                <button onclick="showLoginForm('customer')" class="role-card customer-card">
                    <div class="icon">üõí</div>
                    <h3>Customer</h3>
                    <p style="color: #4b5563; margin-top: 0.5rem;">Browse fresh produce and place orders.</p>
                    <span>Log In / Sign Up</span>
                </button>

                <button onclick="showLoginForm('farmer')" class="role-card farmer-card">
                    <div class="icon">üßë‚Äçüåæ</div>
                    <h3>Farmer</h3>
                    <p style="color: #4b5563; margin-top: 0.5rem;">Manage listings and view order history.</p>
                    <span>Log In / Sign Up</span>
                </button>
                
            </div>
             <p id="authStatus" style="margin-top: 2rem; font-size: 0.875rem; color: #6b7280;">Authentication Ready (User ID: <span id="currentUserIdDisplay">Loading...</span>)</p>
        </div>
    </section>

    <!-- NEW: Login Form Modal (Now with Register Tab) -->
    <div id="loginFormModal" class="modal-backdrop">
        <div class="modal-content" id="loginFormModalContent">
            
            <div class="auth-tabs">
                <div id="loginTab" class="auth-tab active" onclick="switchAuthTab('login')">Log In</div>
                <div id="registerTab" class="auth-tab" onclick="switchAuthTab('register')">Register</div>
            </div>

            <!-- Login Form -->
            <form id="loginForm" class="active" onsubmit="event.preventDefault(); handleLoginSubmit();">
                <h3 id="loginModalTitle">Login as Customer</h3>
                <div class="form-group">
                    <label for="loginEmail">Email</label>
                    <input type="email" id="loginEmail" required placeholder="e.g., user@example.com">
                </div>
                <div class="form-group">
                    <label for="loginPassword">Password</label>
                    <input type="password" id="loginPassword" required placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                </div>
                <button type="submit">Log In</button>
            </form>

            <!-- Register Form -->
            <form id="registerForm" onsubmit="event.preventDefault(); handleRegisterSubmit();">
                <h3 id="registerModalTitle">Register as Customer</h3>
                 <div class="form-group">
                    <label for="registerEmail">Email</label>
                    <input type="email" id="registerEmail" required placeholder="e.g., user@example.com">
                </div>
                <div class="form-group">
                    <label for="registerPassword">Password</label>
                    <input type="password" id="registerPassword" required placeholder="Minimum 6 characters">
                </div>
                <button type="submit">Create Account</button>
            </form>

            <button onclick="closeLoginForm()" class="modal-btn cancel">Cancel</button>
        </div>
    </div>

    <!-- NEW: Edit Product Modal -->
    <div id="editProductModal" class="modal-backdrop">
        <div class="modal-content" id="editProductModalContent">
            <h3>Edit Product Listing</h3>
            <form id="editProductForm" onsubmit="event.preventDefault(); handleUpdateProduct();">
                <input type="hidden" id="editProductId"> <!-- Hidden field to store product ID -->
                <div class="form-group">
                    <label for="editProductName">Product Name</label>
                    <input type="text" id="editProductName" required>
                </div>
                <div class="form-group">
                    <label for="editProductPrice">Price (‚Çπ)</label>
                    <input type="number" id="editProductPrice" required step="0.01">
                </div>
                <div class="form-group" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div>
                        <label for="editProductUnit">Unit</label>
                        <select id="editProductUnit" required>
                            <option value="per kg">per kg</option>
                            <option value="per bundle">per bundle</option>
                            <option value="per piece">per piece</option>
                            <option value="per dozen">per dozen</option>
                        </select>
                    </div>
                    <div>
                        <label for="editProductFreshness">Freshness Status</label>
                        <input type="text" id="editProductFreshness" required>
                    </div>
                </div>
                <div class="form-group">
                    <label for="editProductLocation">Farmer Location (City)</label>
                    <input type="text" id="editProductLocation" required placeholder="e.g., Tirupati">
                </div>
                <div class="form-group">
                    <label for="editProductImage">Image URL</label>
                    <input type="url" id="editProductImage" placeholder="Keep blank to use existing">
                </div>
                
                <button type="submit" class="modal-btn success">Update Product</button>
                <button type="button" onclick="closeEditProductModal()" class="modal-btn cancel">Cancel</button>
            </form>
        </div>
    </div>


    <!-- 2. MAIN APPLICATION CONTAINER -->
    <main id="mainApp">
        <!-- Navigation Bar -->
        <header>
            <nav class="container">
                <div style="display: flex; align-items: center; gap: 0.5rem;">
                    <span class="logo">KisanConnect</span>
                </div>
                
                <div class="nav-info">
                    
                    <!-- Location Block - Now triggers the modal -->
                    <div id="locationBlock" onclick="showLocationModal()" title="Click to select location">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-map-pin"><path d="M12 18s-4-6-4-8a4 4 0 0 1 8 0c0 2-4 8-4 8z"/><circle cx="12" cy="10" r="1"/></svg>
                        <span id="locationText">Detecting Location...</span>
                    </div>

                    <div id="roleDisplay">Role: Customer</div>
                    
                    <!-- Customer Links -->
                    <button onclick="toggleCustomerView('orders')" class="nav-link" id="ordersButton" style="display: none;">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-history"><path d="M3 3v5h5"/><path d="M3.014 11a9 9 0 1 0 5.98-5.748"/><path d="M12 7v5l4 2"/></svg>
                        My Orders
                    </button>
                    
                    <!-- NEW: Farmer Orders Link -->
                    <button onclick="toggleFarmerView('orders')" class="nav-link" id="farmerOrdersButton" style="display: none;">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-package-check"><path d="M16 16h6v-6h-6v6Z"/><path d="M16 16v-2m0 0v-4"/><path d="M20 16v-2m0 0v-4"/><path d="m18 14 1-1 1 1"/><path d="M16 10h-2a2 2 0 0 0-2 2v4a2 2 0 0 0 2 2h2"/><path d="m16 10 2 2-2 2"/><path d="M12 10V8l-2-2-2 2v2"/><path d="M8 10V8l-2-2-2 2v2"/><path d="M4 10V8l-2-2-2 2v2"/><path d="M2.45 6.26 8 3l5.55 3.26"/><path d="M8 3v13.73"/><path d="M12 12V8"/></svg>
                        Orders Received
                    </button>

                    <div style="position: relative; display: none;" id="cartContainer">
                        <button id="cartButton" onclick="toggleCustomerView('cart')">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-shopping-cart">
                                <circle cx="8" cy="21" r="1"/><circle cx="19" cy="21" r="1"/><path d="M2.05 2.05h2l2.66 12.42a2 2 0 0 0 2 1.58h9.78a2 2 0 0 0 1.95-1.57l1.65-7.43H5.15"/>
                            </svg>
                        </button>
                        <span id="cartCounter">0</span>
                    </div>
                    
                    <!-- Sign Out Button (Now always visible when mainApp is active) -->
                    <button onclick="signOutUser()" class="signout-btn">
                        Sign Out
                    </button>
                </div>
            </nav>
        </header>

        <!-- Success/Error Message Modal -->
        <div id="messageBox" class="modal-backdrop">
            <div class="modal-content" id="messageContent">
                <h3 class="modal-title-success" style="font-size: 1.25rem; font-weight: 700; margin-bottom: 0.75rem;">Success!</h3>
                <p id="messageText" style="color: #4b5563; margin-bottom: 1rem;">Item added to your basket.</p>
                <button onclick="closeMessage()" class="modal-btn success">
                    Close
                </button>
            </div>
        </div>

        <!-- NEW: Location Selection Modal -->
        <div id="locationModal" class="modal-backdrop">
            <div class="modal-content" id="locationModalContent">
                <h3 style="font-size: 1.5rem; font-weight: 700; margin-bottom: 1rem;">Select Your Location</h3>
                <p style="color: #4b5563; margin-bottom: 1.5rem;">Choose how you want to set your delivery area.</p>

                <!-- Option 1: Automatic Detection -->
                <div class="option-card" onclick="autoDetectLocation()">
                    <p style="font-weight: 700; color: #2563eb;">üìç Auto-Detect My Location</p>
                    <p style="font-size: 0.875rem; color: #6b7280; margin-top: 0.25rem;">Use your device's GPS for precise location finding.</p>
                </div>

                <p style="text-align: center; margin: 1rem 0; font-weight: 600; color: #6b7280;">OR</p>

                <!-- Option 2: Manual Input -->
                <form onsubmit="event.preventDefault(); manualSetLocation(document.getElementById('manualLocationInput').value);">
                    <label for="manualLocationInput" style="font-weight: 700; color: var(--color-primary-dark);">Manually Enter City/Area Name:</label>
                    <input type="text" id="manualLocationInput" placeholder="e.g., Tirupati, Hyderabad" required>
                    <button type="submit" class="set-location-btn">Set Location</button>
                </form>

                <button onclick="closeLocationModal()" class="modal-btn cancel">Cancel</button>
            </div>
        </div>

        <!-- Gemini LLM Modal (Kept for Farmer Optimization) -->
        <div id="llmModal" class="modal-backdrop">
            <div class="modal-content" id="llmContent" style="max-width: 512px; max-height: 90vh; overflow-y: auto; padding: 2rem 1.5rem;">
                <h3 id="llmModalTitle" style="font-size: 1.5rem; font-weight: 700; margin-bottom: 1rem; display: flex; align-items: center;">
                    <span style="margin-right: 0.5rem;">‚ú®</span> AI Insight
                </h3>
                <div id="llmOutput" style="color: #374151; line-height: 1.5;">
                    <div style="display: flex; justify-content: center; align-items: center; height: 12rem;" id="llmLoading">
                        <div class="spinner" style="border-color: #8b5cf6;"></div>
                        <p style="margin-left: 1rem; color: #8b5cf6; font-weight: 600;">Generating AI analysis...</p>
                    </div>
                </div>
                <button onclick="closeLLMModal()" class="modal-btn llm-close" style="margin-top: 1.5rem;">
                    Close
                </button>
            </div>
        </div>

        <!-- 2A. CUSTOMER VIEW CONTAINER -->
        <div id="customerView" style="display: block;">
            
            <!-- MARKET PAGE -->
            <div id="marketPage" style="display: block;">
                <!-- Hero Section -->
                <section class="hero-section">
                    <div class="container">
                        <h1>Directly from Our Farmers</h1>
                        <p>
                            Connecting you to the freshest, locally-sourced produce, straight from the raitubazar to your doorstep.
                        </p>
                        <div class="hero-buttons">
                            <button onclick="document.getElementById('products').scrollIntoView({behavior: 'smooth'})" class="shop-btn" style="width: auto; min-width: 250px;">
                                Shop Fresh Produce
                            </button>
                            <!-- Generate Recipe Button Removed -->
                        </div>
                    </div>
                </section>

                <!-- Product Grid Section -->
                <section id="products">
                    <div class="container">
                        <h2>Today's Fresh Harvest</h2>
                        
                        <!-- New Filter and Sort Bar -->
                        <div id="filterBar">
                            <div class="filter-group">
                                <label for="priceRange">Max Price (‚Çπ):</label>
                                <input type="range" id="priceRange" min="10" max="250" value="250" step="10" oninput="updatePriceValue(this.value); debouncedFilterAndSort();">
                                <span id="priceRangeValue">‚Çπ250</span>
                            </div>

                            <!-- NEW: Location Filter -->
                            <div class="filter-group">
                                <label for="locationFilter">Location:</label>
                                <select id="locationFilter" onchange="filterAndSortProducts()">
                                    <option value="all">All Locations</option>
                                    <option value="my_location">My Location Only</option>
                                </select>
                            </div>

                            <div class="filter-group">
                                <label for="sortOrder">Sort By:</label>
                                <select id="sortOrder" onchange="filterAndSortProducts()">
                                    <option value="timestamp_desc">Freshness (Newest First)</option>
                                    <option value="price_asc">Price (Low to High)</option>
                                    <option value="price_desc">Price (High to Low)</option>
                                    <option value="name_asc">Name (A-Z)</option>
                                </select>
                            </div>
                        </div>
                        
                        <div id="productGrid" class="product-grid">
                            <!-- Product Cards will be injected here by JavaScript -->
                            <p style="text-align: center; color: #4b5563; grid-column: 1 / -1; padding-top: 3rem;" id="noProductsMessage">
                                Loading products or no products found in the market...
                            </p>
                        </div>
                    </div>
                </section>
            </div>
            
            <!-- CART PAGE -->
            <div id="cartPage" style="display: none;">
                <div class="container">
                    <div class="orders-header">
                        <button onclick="toggleCustomerView('market')" class="back-button">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-arrow-left"><path d="m12 19-7-7 7-7"/><path d="M19 12H5"/></svg>
                            Back to Market
                        </button>
                        <h2 style="margin: 0;">üõí Your Shopping Basket</h2>
                        <span></span>
                    </div>

                    <div class="cart-layout">
                        <div id="cartItemsList">
                            <p class="empty-cart-message">Your basket is currently empty. Start adding some fresh produce!</p>
                        </div>
                        
                        <div class="cart-summary">
                            <h3 style="font-size: 1.25rem; font-weight: 700; color: #1f2937; margin-bottom: 1rem;">Order Summary</h3>
                            
                            <div class="summary-row">
                                <span>Subtotal:</span>
                                <span id="cartSubtotal">‚Çπ0.00</span>
                            </div>
                            <div class="summary-row">
                                <span>GST (5%):</span>
                                <span id="cartTax">‚Çπ0.00</span>
                            </div>
                            <div class="summary-row">
                                <span>Total:</span>
                                <span id="cartGrandTotal">‚Çπ0.00</span>
                            </div>
                            
                            <button onclick="checkout()" class="checkout-btn" id="checkoutBtn">
                                Proceed to Checkout
                            </button>
                            <button onclick="toggleCustomerView('market')" class="modal-btn success" style="margin-top: 0.5rem;">
                                Continue Shopping
                            </button>
                        </div>
                        
                    </div>
                </div>
            </div>

            <!-- NEW: ORDERS PAGE -->
            <div id="ordersPage" style="display: none;">
                <div class="container">
                    <div class="orders-header">
                        <button onclick="toggleCustomerView('market')" class="back-button">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-arrow-left"><path d="m12 19-7-7 7-7"/><path d="M19 12H5"/></svg>
                            Back to Market
                        </button>
                        <h2 style="margin: 0;">üì¶ My Order History</h2>
                        <span></span>
                    </div>
                    <div id="ordersList">
                        <p style="text-align: center; color: #4b5563; padding: 3rem;" id="noOrdersMessage">
                            You haven't placed any orders yet. Start shopping!
                        </p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 2B. FARMER VIEW (Product Selling Interface) -->
        <div id="farmerView" style="display: block;"> <!-- Keep this display: block for toggling -->
            
            <!-- NEW: Farmer Listings Page (Default) -->
            <div id="farmerListingsPage" style="display: block;">
                <div class="container">
                    <h2 style="font-size: 2.25rem; font-weight: 700; text-align: center; color: var(--color-primary-dark); padding-top: 2rem; margin-bottom: 1rem;">
                        üßë‚Äçüåæ Manage Your Farm Listings
                    </h2>
                    <p style="text-align: center; color: #4b5563; margin-bottom: 2rem;">Use this form to add a new product to the RaituBazar.</p>

                    <div class="farmer-form-card">
                        <form id="addProductForm" onsubmit="event.preventDefault(); addProduct();">
                            <div class="form-group">
                                <label for="productName">Product Name</label>
                                <input type="text" id="productName" required placeholder="e.g., Organic Turmeric, Tomatoes">
                            </div>
                            <div class="form-group">
                                <label for="productPrice">Price (‚Çπ)</label>
                                <input type="number" id="productPrice" required placeholder="e.g., 50.00" step="0.01">
                            </div>
                            <div class="form-group" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                <div>
                                    <label for="productUnit">Unit</label>
                                    <select id="productUnit" required>
                                        <option value="per kg">per kg</option>
                                        <option value="per bundle">per bundle</option>
                                        <option value="per piece">per piece</option>
                                        <option value="per dozen">per dozen</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="productFreshness">Freshness Status</label>
                                    <input type="text" id="productFreshness" required placeholder="e.g., Harvested Today">
                                </div>
                            </div>
                            <!-- NEW: Farmer Location Input -->
                            <div class="form-group">
                                <label for="productLocation">Your Location (City)</label>
                                <input type="text" id="productLocation" required placeholder="e.g., Tirupati, Hyderabad">
                            </div>
                            <div class="form-group">
                                <label for="productImage">Image URL (Optional Placeholder)</label>
                                <input type="url" id="productImage" placeholder="https://via.placeholder.com/400x300/...">
                            </div>
                            
                            <button type="submit" class="submit-btn" style="margin-top: 1.5rem;">
                                Add Product to Market
                            </button>
                        </form>
                    </div>

                    <div style="text-align: center; margin-top: 2rem;">
                        <h3 style="font-size: 1.5rem; font-weight: 700; color: var(--color-primary-dark);">My Current Listings</h3>
                        <p style="color: #4b5563;">Listings added by user ID: <span id="farmerIdDisplay">Loading...</span></p>
                    </div>
                    <!-- Container for Farmer's own listings -->
                    <div id="myListingsContainer">
                        <p id="noFarmerListings" style="grid-column: 1 / -1; text-align: center; color: #6b7280;">No products currently listed by you.</p>
                    </div>
                </div>
            </div>
            
            <!-- NEW: Farmer Orders Page -->
            <div id="farmerOrdersPage" style="display: none;">
                <div class="container">
                    <div class="orders-header">
                        <button onclick="toggleFarmerView('listings')" class="back-button">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-arrow-left"><path d="m12 19-7-7 7-7"/><path d="M19 12H5"/></svg>
                            Back to My Listings
                        </button>
                        <h2 style="margin: 0;">üì¶ Orders Received</h2>
                        <span></span>
                    </div>
                    <div id="farmerOrdersList">
                        <p style="text-align: center; color: #4b5563; padding: 3rem;" id="noFarmerOrdersMessage">
                            No orders found for your products.
                        </p>
                        <!-- Farmer order cards will be injected here -->
                    </div>
                </div>
            </div>

        </div>
        
        <!-- Footer (Shared by all main views) -->
        <footer>
            <div class="container">
                <p>&copy; 2024 KisanConnect. A Friendly Farmer-Customer Interface. (User ID: <span id="footerUserId"></span>)</p>
                <div style="display: flex; justify-content: center; gap: 1.5rem;">
                    <a href="#">About Us</a>
                    <a href="#">Farmer Login</a>
                    <a href="#">Support</a>
                </div>
            </div>
        </footer>
    </main>

    <!-- NEW: AI Chatbot Container -->
    <div id="chatContainer" style="display: none;">
        <button id="chatToggleBtn" onclick="toggleChat()">
            <!-- Chat Icon -->
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-message-square"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
        </button>

        <div id="chatWindow" class="">
            <div id="chatHeader">
                <span>KisanConnect AI Helper</span>
            </div>
            <div id="chatMessages">
                <!-- Messages will be rendered here -->
                <div class="chat-message gemini-message">
                    <p>Hello! I'm the KisanConnect AI. I can assist you with product info, ordering, or farming advice based on your current role.</p>
                </div>
            </div>
            <div id="chatInputContainer">
                <input type="text" id="chatInput" placeholder="Ask me anything..." onkeydown="if(event.key === 'Enter') sendMessage()">
                <button id="chatSendBtn" onclick="sendMessage()">Send</button>
            </div>
        </div>
    </div>


    <!-- JavaScript for Data & Interactivity -->
    <script type="module">
        // --- Firebase Imports (using CDN) ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        // MODIFIED: Added Email/Password functions
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut, signInWithEmailAndPassword, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js"; 
        // MODIFIED: Added updateDoc for editing products AND cancelling orders
        import { getFirestore, collection, doc, setDoc, addDoc, onSnapshot, query, where, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js"; 
        
        // --- Modal Utility Function ---
        function closeMessage() {
            document.getElementById('messageContent').style.transform = 'scale(0.95)';
            document.getElementById('messageContent').style.opacity = '0';
            setTimeout(() => { document.getElementById('messageBox').style.display = 'none'; }, 300);
        }
        
        function showMessage(text, type) {
            const messageBox = document.getElementById('messageBox');
            const messageContent = document.getElementById('messageContent');
            const messageText = document.getElementById('messageText');
            const modalTitle = document.querySelector('.modal-title-success');
            const modalBtn = document.querySelector('.modal-btn.success');
            
            messageText.textContent = text;
            
            if (type === 'error') {
                modalTitle.textContent = 'Oops!';
                modalTitle.style.color = 'var(--color-danger)'; 
                modalBtn.style.backgroundColor = 'var(--color-danger)';
            } else { // 'success' or default
                modalTitle.textContent = 'Success!';
                modalTitle.style.color = 'var(--color-primary-dark)';
                modalBtn.style.backgroundColor = 'var(--color-primary-dark)';
            }

            messageBox.style.display = 'flex';
            setTimeout(() => {
                messageContent.style.transform = 'scale(1)';
                messageContent.style.opacity = '1';
            }, 50);
        }

        // --- Gemini API Configuration ---
        // FIX: Hardcoded API key removed for security.
        const apiKey = "AIzaSyCm_nDTXpSESatW4A0rWxgod4-TGf8aHa8"; // API key will be provided by the environment
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
        const MAX_RETRIES = 5;

        // --- Global State & Firebase Setup ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app = null, db = null, auth = null;
        let currentUserId = null;
        let currentUserRole = null;
        let selectedRoleForLogin = null; // NEW: Store role before login form
        let cart = []; // Now stores objects like { product: {...}, quantity: 1 }
        let products = []; 
        let rawProducts = []; 
        let farmerListings = []; 
        let orders = []; 
        let chatHistory = []; 
        let userLocation = { city: 'Unknown', coords: null };


        // NOTE: The code below is modified to allow easy local configuration.
        const isHostedEnvironment = typeof __firebase_config !== 'undefined' && __firebase_config.length > 2;
        let firebaseConfig = {};
        
        // --- START LOCAL CONFIGURATION BLOCK ---
        // FIX: Hardcoded values removed.
        // You MUST replace the placeholder values below with your actual Firebase project config 
        // copied from your Firebase Console (Project Settings -> Add App -> Web App)
        const localFirebaseConfig = { 
            apiKey: "AIzaSyCdk1C-AKuv-IkvxPHDIYR7m8mso7Z3wLI",
            authDomain: "kissanconnect-96f0e.firebaseapp.com",
            projectId: "kissanconnect-96f0e",
            storageBucket: "kissanconnect-96f0e.firebasestorage.app",
            messagingSenderId: "744411301115",
            appId: "1:744411301115:web:008d1376acd641dc1c9c5e",
            measurementId: "G-L7L36N5V7V"
        }; 
        // --- END LOCAL CONFIGURATION BLOCK ---
        
        // Determine which config to use: Canvas environment or local fallback
        if (isHostedEnvironment) {
            firebaseConfig = JSON.parse(__firebase_config);
        } else if (localFirebaseConfig.apiKey !== "YOUR_API_KEY_HERE") {
             // Use the user's provided local config
            firebaseConfig = localFirebaseConfig;
            console.warn("--- LOCAL FIREBASE MODE ---");
            console.warn("Using user-provided local config. Data persistence is ENABLED.");
            console.warn("--------------------------");
        } else {
            // Default mock config (data persistence DISABLED)
            firebaseConfig = localFirebaseConfig; // Still use the structured object for initialization attempts
            console.warn("--- LOCAL MOCK MODE ---");
            console.warn("Database persistence is DISABLED. Update localFirebaseConfig to enable.");
            console.warn("-----------------------");
        }


        // --- DOM Elements ---
        const loginView = document.getElementById('loginView');
        const mainApp = document.getElementById('mainApp');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const authStatus = document.getElementById('authStatus');
        const currentUserIdDisplay = document.getElementById('currentUserIdDisplay');
        const roleDisplay = document.getElementById('roleDisplay');
        const footerUserId = document.getElementById('footerUserId');
        const customerView = document.getElementById('customerView');
        const farmerView = document.getElementById('farmerView');
        const marketPage = document.getElementById('marketPage');
        const cartPage = document.getElementById('cartPage');
        const ordersPage = document.getElementById('ordersPage');
        const productGrid = document.getElementById('productGrid');
        const noProductsMessage = document.getElementById('noProductsMessage');
        const cartCounter = document.getElementById('cartCounter');
        const llmModal = document.getElementById('llmModal'); 
        const llmModalTitle = document.getElementById('llmModalTitle'); 
        const llmOutput = document.getElementById('llmOutput'); 
        const llmLoading = document.getElementById('llmLoading'); 
        const priceRangeInput = document.getElementById('priceRange');
        const priceRangeValueDisplay = document.getElementById('priceRangeValue');
        const sortOrderSelect = document.getElementById('sortOrder');
        const locationFilterSelect = document.getElementById('locationFilter'); // NEW
        const myListingsContainer = document.getElementById('myListingsContainer');
        const noFarmerListingsMessage = document.getElementById('noFarmerListings');
        const farmerIdDisplay = document.getElementById('farmerIdDisplay');
        const cartItemsList = document.getElementById('cartItemsList');
        const cartSubtotalDisplay = document.getElementById('cartSubtotal');
        const cartTaxDisplay = document.getElementById('cartTax');
        const cartGrandTotalDisplay = document.getElementById('cartGrandTotal');
        const checkoutBtn = document.getElementById('checkoutBtn');
        const ordersList = document.getElementById('ordersList'); 
        const noOrdersMessage = document.getElementById('noOrdersMessage'); 
        const ordersButton = document.getElementById('ordersButton');
        const cartContainer = document.getElementById('cartContainer');
        const locationText = document.getElementById('locationText');
        const locationModal = document.getElementById('locationModal');
        const manualLocationInput = document.getElementById('manualLocationInput');
        
        // Chatbot DOM elements
        const chatContainer = document.getElementById('chatContainer');
        const chatWindow = document.getElementById('chatWindow');
        const chatMessages = document.getElementById('chatMessages');
        const chatInput = document.getElementById('chatInput');
        
        // Login Form Modal Elements
        const loginFormModal = document.getElementById('loginFormModal');
        const loginFormModalContent = document.getElementById('loginFormModalContent');
        const loginModalTitle = document.getElementById('loginModalTitle');
        const registerModalTitle = document.getElementById('registerModalTitle');
        const loginEmailInput = document.getElementById('loginEmail');
        const loginPasswordInput = document.getElementById('loginPassword');
        const registerEmailInput = document.getElementById('registerEmail');
        const registerPasswordInput = document.getElementById('registerPassword');
        const loginTab = document.getElementById('loginTab');
        const registerTab = document.getElementById('registerTab');
        const loginForm = document.getElementById('loginForm');
        const registerForm = document.getElementById('registerForm');

        // Edit Product Modal Elements
        const editProductModal = document.getElementById('editProductModal');
        const editProductModalContent = document.getElementById('editProductModalContent');
        const editProductIdInput = document.getElementById('editProductId');
        const editProductNameInput = document.getElementById('editProductName');
        const editProductPriceInput = document.getElementById('editProductPrice');
        const editProductUnitSelect = document.getElementById('editProductUnit');
        const editProductFreshnessInput = document.getElementById('editProductFreshness');
        const editProductLocationInput = document.getElementById('editProductLocation');
        const editProductImageInput = document.getElementById('editProductImage');
        
        // NEW: Farmer View Elements
        const farmerOrdersButton = document.getElementById('farmerOrdersButton');
        const farmerListingsPage = document.getElementById('farmerListingsPage');
        const farmerOrdersPage = document.getElementById('farmerOrdersPage');
        const farmerOrdersList = document.getElementById('farmerOrdersList');
        const noFarmerOrdersMessage = document.getElementById('noFarmerOrdersMessage');


        // --- Initialization and View Logic ---
        async function initApp() { 
            setLogLevel('Debug');
            
            const isConfigValid = firebaseConfig.apiKey && firebaseConfig.apiKey !== "YOUR_API_KEY_HERE";

            // Initialize Firebase regardless of mode to check for existing logged-in user
            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                
                // Only initialize DB if config is valid (needed for listeners)
                if (isHostedEnvironment || isConfigValid) {
                     db = getFirestore(app);
                } else {
                     db = null; // Explicitly null in mock mode
                }

                // Check auth state AFTER initializing auth
                await checkAuthState(); 

            } catch (error) {
                console.error("Firebase Initialization FAILED:", error);
                currentUserId = 'error-' + Math.random().toString(36).substring(2, 6);
                renderLoginView(false); // Render login view even if init fails
            }
            
            locationText.textContent = 'Select Location';
        }

        // FIX: Modified checkAuthState to use __initial_auth_token
        async function checkAuthState() {
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    // User is already signed in
                    currentUserId = user.uid;
                    
                    if (currentUserRole) { 
                        renderView('main');
                    } else {
                        // User is signed in (e.g., custom token) but hasn't selected a role
                        renderLoginView(true); 
                    }
                } else {
                    // No user signed in, attempt sign-in
                    try {
                        if (initialAuthToken) {
                            // Use the provided custom token if available
                            await signInWithCustomToken(auth, initialAuthToken);
                            // onAuthStateChanged will run again with the new user
                        } else if (firebaseConfig.apiKey && firebaseConfig.apiKey !== "YOUR_API_KEY_HERE") {
                            // Fallback to anonymous sign-in for local dev
                            await signInAnonymously(auth);
                            // onAuthStateChanged will run again with the new user
                        } else {
                            throw new Error("Mock config or invalid key, skipping sign-in.");
                        }
                    } catch (e) {
                        console.warn("Auth sign-in attempt failed or skipped:", e.message, e);
                        // If auth fails (e.g., operation not allowed), show login view without DB connection
                        currentUserId = 'auth-fail-' + Math.random().toString(36).substring(2, 6);
                        renderLoginView(false); // Show login, DB is likely off
                    }
                }
            });
        }
        
        
        function renderLoginView(isDatabaseConnected) {
            loadingIndicator.style.display = 'none';
            mainApp.style.display = 'none';
            chatContainer.style.display = 'none'; // Hide chat on login view
            loginView.style.display = 'flex';
            currentUserIdDisplay.textContent = currentUserId || 'Not Signed In';

            const isConfigPlaceholder = localFirebaseConfig.apiKey === "YOUR_API_KEY_HERE";

            if (isDatabaseConnected && db) {
                authStatus.textContent = `Authentication Ready (User ID: ${currentUserId}). Database is ON.`;
                authStatus.style.color = 'var(--color-primary-dark)';
            } else if (isConfigPlaceholder && !isHostedEnvironment) {
                 authStatus.textContent = `Local Mock Mode (User ID: ${currentUserId}). Database is OFF. (PASTE YOUR FIREBASE CONFIG to enable persistence)`;
                 authStatus.style.color = 'var(--color-danger)'; // Red for critical alert
            } else {
                // Config present but connection failed (Auth/Rules failure) or in Canvas without token
                authStatus.textContent = `Authentication failed. (User ID: ${currentUserId}). Database is OFF. (Check Firebase rules/network.)`;
                authStatus.style.color = '#f59e0b';
            }
        }

        function renderView(view) {
            loadingIndicator.style.display = 'none';
            
            if (view === 'main') {
                loginView.style.display = 'none';
                mainApp.style.display = 'block';
                chatContainer.style.display = 'block'; // Show chat on main app
                
                // Reset chat history when user logs in/switches role
                chatHistory = [];
                // Add initial message to the chat history
                chatHistory.push({
                    role: "model",
                    parts: [{ text: "Hello! I'm the KisanConnect AI. I can assist you with product info, ordering, or farming advice based on your current role." }]
                });

                // Clear previous chat messages before rendering new ones
                chatMessages.innerHTML = '';
                renderMessage("Hello! I'm the KisanConnect AI. I can assist you with product info, ordering, or farming advice based on your current role.", "gemini");

                
                roleDisplay.textContent = `Role: ${currentUserRole}`;
                footerUserId.textContent = currentUserId;
                
                customerView.style.display = 'none';
                farmerView.style.display = 'none';
                
                // Toggle navigation visibility based on role
                if (currentUserRole === 'customer') {
                    customerView.style.display = 'block';
                    ordersButton.style.display = 'flex'; // Show for Customer
                    farmerOrdersButton.style.display = 'none'; // Hide for Customer
                    cartContainer.style.display = 'block'; // Show for Customer
                    setupProductListener(); 
                    setupOrderListener();
                    toggleCustomerView('market');
                } else if (currentUserRole === 'farmer') {
                    farmerView.style.display = 'block';
                    ordersButton.style.display = 'none'; // Hide for Farmer
                    farmerOrdersButton.style.display = 'flex'; // Show for Farmer
                    cartContainer.style.display = 'none'; // Hide for Farmer
                    farmerIdDisplay.textContent = currentUserId;
                    setupFarmerListingsListener(); 
                    setupFarmerOrdersListener(); // NEW
                    toggleFarmerView('listings'); // NEW
                } 
            } else { // 'login' view
                mainApp.style.display = 'none';
                chatContainer.style.display = 'none'; 
                loginView.style.display = 'flex';
                // Reset role state when returning to login
                currentUserRole = null;
                selectedRoleForLogin = null;
            }
        }
        
        function toggleCustomerView(page) {
            marketPage.style.display = 'none';
            cartPage.style.display = 'none';
            ordersPage.style.display = 'none';
            
            if (page === 'cart') {
                cartPage.style.display = 'block';
                renderCartPage(); 
            } else if (page === 'orders') {
                ordersPage.style.display = 'block';
            } else { // default to market
                marketPage.style.display = 'block';
            }
        }
        
        // NEW: Toggle for Farmer View
        function toggleFarmerView(page) {
            farmerListingsPage.style.display = 'none';
            farmerOrdersPage.style.display = 'none';
            
            if (page === 'orders') {
                farmerOrdersPage.style.display = 'block';
            } else { // default to listings
                farmerListingsPage.style.display = 'block';
            }
        }


        // --- LOGIN / REGISTRATION ---

        function switchAuthTab(tab) {
            if (tab === 'login') {
                loginTab.classList.add('active');
                registerTab.classList.remove('active');
                loginForm.classList.add('active');
                registerForm.classList.remove('active');
            } else {
                loginTab.classList.remove('active');
                registerTab.classList.add('active');
                loginForm.classList.remove('active');
                registerForm.classList.add('active');
            }
            // Update titles based on role
            loginModalTitle.textContent = `Login as ${selectedRoleForLogin}`;
            registerModalTitle.textContent = `Register as ${selectedRoleForLogin}`;
        }

        // MODIFIED: This function now just shows the login form modal
        function showLoginForm(role) {
            if (role !== 'customer' && role !== 'farmer') return;
            selectedRoleForLogin = role; // Store the selected role
            
            // Set default tab to login
            switchAuthTab('login'); 
            
            // Clear previous inputs
            loginEmailInput.value = '';
            loginPasswordInput.value = '';
            registerEmailInput.value = '';
            registerPasswordInput.value = '';
            
            // Show the modal
            loginFormModal.style.display = 'flex';
            setTimeout(() => {
                loginFormModalContent.style.transform = 'scale(1)';
                loginFormModalContent.style.opacity = '1';
            }, 50);
        }

        function closeLoginForm() {
            loginFormModalContent.style.transform = 'scale(0.95)';
            loginFormModalContent.style.opacity = '0';
            setTimeout(() => { loginFormModal.style.display = 'none'; }, 300);
            selectedRoleForLogin = null; // Clear selected role on cancel
        }

        // NEW: Handle Registration
        async function handleRegisterSubmit() {
            const email = registerEmailInput.value;
            const password = registerPasswordInput.value;
            
            if (!auth) {
                showMessage("Authentication service is not ready. Please try again.", 'error');
                return;
            }
            if (password.length < 6) {
                showMessage("Password must be at least 6 characters long.", 'error');
                return;
            }

            try {
                // Attempt to create user with Firebase
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;
                
                // --- Registration Successful ---
                currentUserRole = selectedRoleForLogin; // Set the role selected *before* registration
                currentUserId = user.uid; // Set the actual user ID from Firebase
                
                closeLoginForm();
                showMessage(`Welcome! Account created as ${currentUserRole}.`, 'success');
                renderView('main'); // Proceed to the main application view

            } catch (error) {
                // --- Registration Failed ---
                console.error("Firebase Register Error:", error.code, error.message);
                let errorMessage = "Registration failed. Please try again.";
                if (error.code === 'auth/email-already-in-use') {
                    errorMessage = "This email address is already in use.";
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage = "Please enter a valid email address.";
                } else if (error.code === 'auth/weak-password') {
                    errorMessage = "Your password is too weak. Please choose a stronger one.";
                }
                showMessage(errorMessage, 'error');
            }
        }

        // Handle login form submission
        async function handleLoginSubmit() {
            const email = loginEmailInput.value;
            const password = loginPasswordInput.value;
            
            if (!auth) {
                showMessage("Authentication service is not ready. Please try again.", 'error');
                return;
            }

            try {
                // Attempt to sign in with Firebase
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;
                
                // --- Login Successful ---
                currentUserRole = selectedRoleForLogin; // Set the role selected *before* login
                currentUserId = user.uid; // Set the actual user ID from Firebase
                
                closeLoginForm();
                showMessage(`Welcome back! Logged in as ${currentUserRole}.`, 'success');
                renderView('main'); // Proceed to the main application view

            } catch (error) {
                // --- Login Failed ---
                console.error("Firebase Login Error:", error.code, error.message);
                let errorMessage = "Login failed. Please check your email and password.";
                if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential') {
                    errorMessage = "Invalid email or password provided.";
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage = "Please enter a valid email address.";
                }
                showMessage(errorMessage, 'error');
            }
        }
        
        // This function is no longer needed as the tab UI replaces it
        // window.showRegisterMessage = showRegisterMessage;


        // --- SIGN OUT LOGIC ---
        function signOutUser() {
            if (auth && auth.currentUser) {
                // Sign out the current user (whether anonymous or email/pass)
                signOut(auth).then(() => {
                    console.log("[Auth] User signed out.");
                    // Reset all state variables
                    currentUserId = null; 
                    currentUserRole = null;
                    selectedRoleForLogin = null;
                    cart = []; 
                    products = []; 
                    rawProducts = []; 
                    farmerListings = []; 
                    orders = []; 
                    chatHistory = [];
                    updateCartCount();
                    renderView('login'); // Go back to the login/role selection view
                }).catch((error) => {
                    console.error("[Auth] Error signing out:", error);
                    showMessage("Error signing out. Please try again.", 'error');
                });
            } else {
                 // If auth object doesn't exist, just reset state
                 currentUserId = null; 
                 currentUserRole = null;
                 cart = []; products = []; rawProducts = []; farmerListings = []; orders = []; 
                 updateCartCount();
                 renderView('login'); 
            }
        }


        // --- GEOLOCATION LOGIC ---
        // FIX: Hardcoded API key removed for security.
        const OPENCAGE_API_KEY = "46eaeb0df34a4ef6ac4ed5eae238a0d9"; // Add your OpenCage API key here for local testing

        async function reverseGeocode(lat, lon) {
            // FIX: Add check for API key
            if (!OPENCAGE_API_KEY) {
                console.warn("OpenCage API Key is missing. Returning mock location.");
                return 'Mock Location';
            }
            const url = `https://api.opencagedata.com/geocode/v1/json?q=${lat}+${lon}&key=${OPENCAGE_API_KEY}`;
            try {
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.results && data.results.length > 0) {
                    // Extract the city/town name from the components
                    const components = data.results[0].components;
                    const city = components.city || components.town || components.village || components.county || components.state_district || 'Area';
                    return city;
                }
                return 'Unknown Area';
            } catch (error) {
                console.error("Reverse Geocoding failed:", error);
                return 'Network Error';
            }
        }

        function handleGeolocationSuccess(position) {
            const lat = position.coords.latitude;
            const lon = position.coords.longitude;
            
            userLocation.coords = { lat, lon };
            locationText.textContent = 'Fetching Area...';

            closeLocationModal();
            
            if (!OPENCAGE_API_KEY) {
                 // Mock behavior if API key is not set
                 userLocation.city = 'Local Demo Area';
                 locationText.textContent = userLocation.city;
                 showMessage(`Location set to 'Local Demo Area'. Add OpenCage API key to enable geocoding.`, 'success');
                 filterAndSortProducts();
                 return;
            }

            reverseGeocode(lat, lon).then(city => {
                userLocation.city = city;
                locationText.textContent = city;
                showMessage(`Location set to ${city} via Auto-Detect.`, 'success');
                filterAndSortProducts(); // Re-filter products on location change
            }).catch(() => {
                userLocation.city = 'Area Found';
                locationText.textContent = 'Area Found';
                showMessage(`Location set to generic area. Geocoding failed.`, 'error');
            });
        }

        function handleGeolocationError(error) {
            console.warn('Geolocation Error:', error.code, error.message);
            closeLocationModal();
            userLocation.city = 'Location Disabled';
            locationText.textContent = 'Location Disabled';
            showMessage('Please enable location services and try again.', 'error');
        }

        function showLocationModal() {
            locationModal.style.display = 'flex';
            setTimeout(() => {
                document.getElementById('locationModalContent').style.transform = 'scale(1)';
                document.getElementById('locationModalContent').style.opacity = '1';
            }, 50);
        }

        function closeLocationModal() {
            document.getElementById('locationModalContent').style.transform = 'scale(0.95)';
            document.getElementById('locationModalContent').style.opacity = '0';
            setTimeout(() => { locationModal.style.display = 'none'; }, 300);
        }
        
        function manualSetLocation(cityName) {
            if (!cityName || cityName.trim() === '') {
                showMessage('Please enter a valid city or area name.', 'error');
                return;
            }
            userLocation.city = cityName.trim();
            locationText.textContent = cityName.trim();
            
            closeLocationModal();
            showMessage(`Location manually set to ${cityName.trim()}.`, 'success');
            
            // Re-filter products on location change
            filterAndSortProducts(); 
        }

        function autoDetectLocation() {
            setTimeout(() => {
                if (navigator.geolocation) {
                    locationText.textContent = 'Detecting...';
                    navigator.geolocation.getCurrentPosition(handleGeolocationSuccess, handleGeolocationError, {
                        enableHighAccuracy: true,
                        timeout: 5000,
                        maximumAge: 0
                    });
                } else {
                    closeLocationModal();
                    userLocation.city = 'Geo Not Supported';
                    locationText.textContent = 'Geo Not Supported';
                    showMessage('Your browser does not support Geolocation.', 'error');
                }
            }, 50); 
        }


        // --- CUSTOMER LOGIC: REAL-TIME DATA LISTENER & FILTERING ---
        function debounce(func, delay) {
            let timeoutId;
            return function(...args) {
                clearTimeout(timeoutId);
                timeoutId = setTimeout(() => {
                    func.apply(this, args);
                }, delay);
            };
        }

        const debouncedFilterAndSort = debounce(filterAndSortProducts, 200); 

        function updatePriceValue(value) {
            priceRangeValueDisplay.textContent = `‚Çπ${value}`;
        }
        
        // MODIFIED: Added Location Filtering
        function filterAndSortProducts() {
            let filteredProducts = [...rawProducts];

            // 1. Filter by Price
            const maxPrice = parseFloat(priceRangeInput.value);
            filteredProducts = filteredProducts.filter(p => p.price <= maxPrice);

            // 2. Filter by Location (NEW)
            const locationFilter = locationFilterSelect.value;
            if (locationFilter === 'my_location' && userLocation.city && userLocation.city !== 'Unknown' && userLocation.city !== 'Select Location') {
                filteredProducts = filteredProducts.filter(p => 
                    p.farmerLocation && p.farmerLocation.toLowerCase() === userLocation.city.toLowerCase()
                );
            }

            // 3. Sort
            const sortOrder = sortOrderSelect.value;
            filteredProducts.sort((a, b) => {
                switch (sortOrder) {
                    case 'price_asc': return a.price - b.price;
                    case 'price_desc': return b.price - a.price;
                    case 'name_asc': return a.name.localeCompare(b.name);
                    case 'timestamp_desc': 
                        const timeA = a.timestamp ? new Date(a.timestamp).getTime() : 0;
                        const timeB = b.timestamp ? new Date(b.timestamp).getTime() : 0;
                        return timeB - timeA;
                    default: return 0;
                }
            });

            products = filteredProducts; 
            renderProducts(); 
        }

        // MODIFIED: Uses product.farmerId and product.farmerLocation
        function createProductCardHTML(product) {
            const price = parseFloat(product.price);
            const imageFallback = product.image || `https://via.placeholder.com/400x250/e0ffec/37a552?text=${encodeURIComponent(product.name.replace(/\s/g, '+'))}`;
            const displayFarmerId = product.farmerId ? product.farmerId.substring(0, 8) + '...' : 'N/A';
            const displayLocation = product.farmerLocation || 'Unknown Location';

            return `
                <div class="product-card">
                    <img src="${product.image}" alt="${product.name}" 
                         onerror="this.onerror=null;this.src='${imageFallback}';"
                         loading="lazy">
                    <div class="card-content">
                        <div class="card-header">
                            <h3>${product.name}</h3>
                            <span class="freshness-tag">${product.freshness}</span>
                        </div>
                        <p class="price-tag">‚Çπ${price.toFixed(2)} <span class="unit">/${product.unit.replace('per ', '').trim()}</span></p>
                        <p class="seller-info">Seller: ${displayFarmerId}</p>
                        <p class="location-info">From: ${displayLocation}</p>
                        <button onclick="addToCart('${product.id}')" class="add-to-cart-btn">
                            Add to Basket
                        </button>
                    </div>
                </div>
            `;
        }

        function renderProducts() {
            if (!productGrid) return; 
            
            productGrid.innerHTML = ''; 

            if (products.length === 0 && rawProducts.length === 0) {
                 productGrid.innerHTML = `<p style="text-align: center; color: #4b5563; grid-column: 1 / -1; padding-top: 3rem;" id="noProductsMessage">
                                Loading products or no products found in the market...
                            </p>`;
            } else if (products.length === 0 && rawProducts.length > 0) {
                 productGrid.innerHTML = `<p style="text-align: center; color: #4b5563; grid-column: 1 / -1; padding-top: 3rem;" id="noProductsMessage">
                                No products match your current filters.
                            </p>`;
            } else {
                const html = products.map(createProductCardHTML).join('');
                productGrid.innerHTML = html;
            }
        }


        function addToCart(productId) {
            const productToAdd = rawProducts.find(p => p.id === productId); 
            if (!productToAdd) return; 

            const existingCartItemIndex = cart.findIndex(item => item.product.id === productId);

            if (existingCartItemIndex > -1) {
                cart[existingCartItemIndex].quantity++;
            } else {
                cart.push({ product: productToAdd, quantity: 1 });
            }
            
            updateCartCount();
            showMessage(`${productToAdd.name} added to basket!`, 'success');
            if (cartPage.style.display === 'block') {
                renderCartPage();
            }
        }

        function updateCartQuantity(productId, change) {
            const cartItemIndex = cart.findIndex(item => item.product.id === productId);
            if (cartItemIndex === -1) return; 

            const newQuantity = cart[cartItemIndex].quantity + change;

            if (newQuantity <= 0) {
                removeFromCart(cartItemIndex);
            } else {
                cart[cartItemIndex].quantity = newQuantity;
                renderCartPage(); 
            }
        }

        function removeFromCart(index) {
            if (index < 0 || index >= cart.length) return; 
            const name = cart[index].product.name;
            cart.splice(index, 1);
            // FIX: Use 'error' style for a red removal message
            showMessage(`${name} removed from basket.`, 'error');
            renderCartPage(); 
        }


        // MODIFIED: Now stores farmerId and farmerLocation directly
        function setupProductListener() {
             if (!db) {
                 if(noProductsMessage) noProductsMessage.textContent = "Cannot load market data: Running in local mock mode.";
                rawProducts = [ 
                    { id: 'p1', name: 'Organic Tomatoes', price: 50.00, unit: 'per kg', farmerId: 'mock1...', farmerLocation: 'Tirupati', image: 'https://via.placeholder.com/400x300/e0ffec/37a552?text=Tomatoes', freshness: 'Today', timestamp: new Date().toISOString() },
                    { id: 'p2', name: 'Fresh Spinach', price: 30.00, unit: 'per bundle', farmerId: 'mock2...', farmerLocation: 'Hyderabad', image: 'https://via.placeholder.com/400x300/e0ffec/37a552?text=Spinach', freshness: 'Yesterday', timestamp: new Date(Date.now() - 86400000).toISOString() },
                    { id: 'p3', name: 'Local Milk', price: 80.00, unit: 'per liter', farmerId: 'mock1...', farmerLocation: 'Tirupati', image: 'https://via.placeholder.com/400x300/e0ffec/37a552?text=Milk', freshness: 'Today', timestamp: new Date().toISOString() }
                ];
                priceRangeInput.min = 10; priceRangeInput.max = 250; priceRangeInput.value = 250; 
                updatePriceValue(250); 
                filterAndSortProducts(); 
                return;
            }

            const productsCollectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'products');
            
            onSnapshot(productsCollectionRef, (snapshot) => {
                const fetchedProducts = [];
                let maxPrice = 0;

                snapshot.forEach(doc => { 
                     const data = doc.data();
                    const price = parseFloat(data.price);
                    
                    if (price > maxPrice) { maxPrice = price; }
                    
                    fetchedProducts.push({
                        id: doc.id, 
                        name: data.name, 
                        price: price, 
                        unit: data.unit,
                        farmerId: data.farmerId, // FIX: Store raw ID
                        farmerLocation: data.farmerLocation, // NEW: Store location
                        image: data.image, 
                        freshness: data.freshness,
                        timestamp: data.timestamp || new Date(0).toISOString() 
                    });
                 });
                
                rawProducts = fetchedProducts;
                
                maxPrice = Math.ceil(maxPrice / 10) * 10;
                const newMax = maxPrice > 0 ? maxPrice : 250; 
                const currentValue = parseFloat(priceRangeInput.value);
                
                priceRangeInput.max = newMax;
                if (currentValue === 250 || currentValue > newMax) { 
                    priceRangeInput.value = newMax; 
                }
                
                updatePriceValue(priceRangeInput.value); 
                filterAndSortProducts(); 

                console.log(`[Firestore] Updated product list. Total: ${rawProducts.length}. Max Price: ${newMax}`);

            }, (error) => { 
                console.error("Error listening to products:", error);
                if(noProductsMessage) noProductsMessage.textContent = "Error loading products. (Check Permissions)";
            });
        }


        // --- FARMER LOGIC: CRUD & LISTINGS ---
        
        async function optimizeListing(productId) {
            // FIX: Check for empty string key
            if (apiKey === "" && !isHostedEnvironment) {
                renderMessage("The AI Assistant is not configured. Please add your Gemini API Key.", "gemini");
                return;
            }
            
            const listing = farmerListings.find(p => p.id === productId);
            if (!listing) return;

            showLLMModal('Optimizing Listing...', true);
            llmOutput.innerHTML = llmLoading.outerHTML;

            const userQuery = `You are a market expert. Provide concrete suggestions to improve this product listing for better customer appeal and sales: Product Name: ${listing.name}, Price: ‚Çπ${listing.price} / ${listing.unit}, Freshness: ${listing.freshness}, Location: ${listing.farmerLocation}. Focus on the name, description clarity, and unit usage. Respond in a brief list format.`;

            const systemPrompt = `You are the KisanConnect Farm Business AI. Your goal is to help the farmer maximize their sales, improve product quality, and manage their listings. Your tone is helpful, professional, and advisory. Context: The user is a farmer using the KisanConnect app.`;

            const payload = { 
                contents: [{ role: "user", parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] } 
            };

            try {
                const response = await retryFetch(apiUrl, { 
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json' }, 
                    body: JSON.stringify(payload) 
                });

                const generatedText = response.candidates?.[0]?.content?.parts?.[0]?.text || "No suggestions found.";
                
                llmOutput.innerHTML = `
                    <h4 style="font-size: 1.1rem; font-weight: 700; margin-bottom: 0.5rem; color: #1f2937;">Suggestions for "${listing.name}":</h4>
                    <div style="padding-left: 1rem; border-left: 3px solid #8b5cf6;">
                        ${markdownToHtml(generatedText)}
                    </div>
                `;
            } catch (error) {
                llmOutput.innerHTML = `<p style="color: var(--color-danger);">Error: Could not connect to AI service. Check your Gemini API key and network connection.</p>`;
                console.error("Gemini API Optimization Error:", error);
            }
        }
        
        // MODIFIED: Includes farmerLocation
        function showEditProductModal(productId) {
            const product = farmerListings.find(p => p.id === productId);
            if (!product) return;

            editProductIdInput.value = product.id;
            editProductNameInput.value = product.name;
            editProductPriceInput.value = product.price.toFixed(2);
            editProductUnitSelect.value = product.unit;
            editProductFreshnessInput.value = product.freshness;
            editProductLocationInput.value = product.farmerLocation || ''; // NEW
            editProductImageInput.value = product.image || ''; 

            editProductModal.style.display = 'flex';
            setTimeout(() => {
                editProductModalContent.style.transform = 'scale(1)';
                editProductModalContent.style.opacity = '1';
            }, 50);
        }

        function closeEditProductModal() {
            editProductModalContent.style.transform = 'scale(0.95)';
            editProductModalContent.style.opacity = '0';
            setTimeout(() => { editProductModal.style.display = 'none'; }, 300);
        }

        // MODIFIED: Includes farmerLocation
        async function handleUpdateProduct() {
            if (!db) { showMessage("Cannot update product. Database connection failed.", 'error'); return; }

            // Client-side check (first line of defense)
            if (currentUserRole !== 'farmer') {
                showMessage("Access Denied. Only farmers can update products.", 'error');
                return;
            }

            const productId = editProductIdInput.value;
            const updatedData = {
                name: editProductNameInput.value,
                price: parseFloat(editProductPriceInput.value).toFixed(2),
                unit: editProductUnitSelect.value,
                freshness: editProductFreshnessInput.value,
                farmerLocation: editProductLocationInput.value.trim(), // NEW
                image: editProductImageInput.value || farmerListings.find(p => p.id === productId)?.image || '', 
                timestamp: new Date().toISOString() 
            };

            if (!updatedData.name || isNaN(updatedData.price) || !updatedData.unit || !updatedData.freshness || !updatedData.farmerLocation) {
                showMessage("Please fill out all required fields, including location.", 'error');
                return;
            }

            try {
                // NOTE: This is NOT secure. A malicious user can bypass this.
                // REAL security requires Firestore Rules to check if auth.uid == doc.data.farmerId
                console.warn("Attempting insecure update. Firestore Rules MUST be implemented for security.");
                const productDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'products', productId);
                await updateDoc(productDocRef, updatedData);
                closeEditProductModal();
                showMessage(`Product "${updatedData.name}" updated successfully!`, 'success');
            } catch (e) {
                console.error("Error updating product:", e);
                showMessage("Failed to update product. Check console/Firestore Rules.", 'error');
            }
        }
        
        
        function setupFarmerListingsListener() {
             if (!db) { 
                if(noFarmerListingsMessage) noFarmerListingsMessage.innerHTML = "Cannot load listings: Running in local mock mode.";
                farmerListings = [
                     { id: 'p-mock-1', name: 'Mock Item 1', price: 10.00, unit: 'per kg', freshness: 'Mock Today', farmerLocation: 'Tirupati', farmerId: currentUserId },
                     { id: 'p-mock-2', name: 'Mock Item 2', price: 25.00, unit: 'per bundle', freshness: 'Mock Yesterday', farmerLocation: 'Hyderabad', farmerId: currentUserId }
                ];
                renderFarmerListings();
                return; 
            }

            const productsCollectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'products');
            const farmerQuery = query(productsCollectionRef, where('farmerId', '==', currentUserId));

            onSnapshot(farmerQuery, (snapshot) => { 
                const fetchedListings = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    fetchedListings.push({
                        id: doc.id, 
                        name: data.name, 
                        price: parseFloat(data.price), 
                        unit: data.unit,
                        freshness: data.freshness, 
                        farmerLocation: data.farmerLocation, // NEW
                        image: data.image, 
                        farmerId: data.farmerId
                    });
                });
                
                farmerListings = fetchedListings;
                renderFarmerListings();
             }, 
            (error) => { 
                console.error("Error listening to farmer listings:", error);
                if(noFarmerListingsMessage) noFarmerListingsMessage.innerHTML = "Error loading your listings. (Check Permissions)";
            });
        }
        
        // MODIFIED: Includes farmerLocation
        function renderFarmerListings() {
             if (!myListingsContainer) return; 
            if (farmerListings.length === 0) {
                 if(noFarmerListingsMessage) myListingsContainer.innerHTML = `<p id="noFarmerListings" style="grid-column: 1 / -1; text-align: center; color: #6b7280;">No products currently listed by you.</p>`;
            } else {
                farmerListings.sort((a, b) => a.name.localeCompare(b.name));
                const html = farmerListings.map(p => `
                    <div class="listing-card">
                        <div class="listing-details">
                            <h4>${p.name}</h4>
                            <p>Price: ‚Çπ${p.price.toFixed(2)} / ${p.unit}</p>
                            <p>Freshness: ${p.freshness}</p>
                            <p>Location: ${p.farmerLocation || 'N/A'}</p>
                        </div>
                        <div class="listing-buttons">
                            <button onclick="showEditProductModal('${p.id}')" class="edit-btn">Edit</button> 
                            <button onclick="deleteProduct('${p.id}', '${p.name}')" class="delete-btn">Delete</button>
                        </div>
                        <button onclick="optimizeListing('${p.id}')" class="optimize-btn">‚ú® Optimize Listing</button>
                    </div>
                `).join('');
                
                myListingsContainer.innerHTML = html;
            }
        }
        
        // MODIFIED: Includes farmerLocation
        async function addProduct() {
             const nameInput = document.getElementById('productName');
             const priceInput = document.getElementById('productPrice');
             const unitInput = document.getElementById('productUnit');
             const freshnessInput = document.getElementById('productFreshness');
             const locationInput = document.getElementById('productLocation'); // NEW
             const imageInput = document.getElementById('productImage');

             if (!nameInput || !priceInput || !unitInput || !freshnessInput || !imageInput || !locationInput) {
                 showMessage("Error: Form elements not found.", 'error');
                 return;
             }

             const name = nameInput.value.trim();
             const price = parseFloat(priceInput.value).toFixed(2);
             const unit = unitInput.value;
             const freshness = freshnessInput.value.trim();
             const location = locationInput.value.trim(); // NEW
             const image = imageInput.value.trim() || `https://via.placeholder.com/400x300/e0ffec/37a552?text=${encodeURIComponent(name.replace(/\s/g, '+'))}`; 


            if (!name || isNaN(price) || !unit || !freshness || !location) { // NEW: Added location check
                 showMessage("Please fill out all required product details, including location.", 'error');
                 return;
             }
            
            if (!db) { 
                showMessage(`Product "${name}" added to mock list, but NOT SAVED to database.`, 'error'); 
                 if(document.getElementById('addProductForm')) document.getElementById('addProductForm').reset(); 
                return;
            }

            const newProduct = { 
                 name: name, 
                 price: price, 
                 unit: unit, 
                 freshness: freshness, 
                 farmerLocation: location, // NEW
                 image: image, 
                 farmerId: currentUserId,
                 timestamp: new Date().toISOString()
             };

            try {
                const productsCollectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'products');
                await addDoc(productsCollectionRef, newProduct); 
                setTimeout(() => { 
                    showMessage(`Product "${name}" successfully added!`, 'success'); 
                }, 50); 
                 if(document.getElementById('addProductForm')) document.getElementById('addProductForm').reset(); 
            } catch (e) { 
                 console.error("Error adding product:", e);
                 showMessage("Failed to add product. Check console for details.", 'error');
             }
        }

        async function deleteProduct(productId, productName) {
            // Client-side check (first line of defense)
            if (currentUserRole !== 'farmer') { 
                showMessage("Access Denied. Only farmers can delete listings.", 'error'); 
                return; 
            }
            if (!db) { 
                showMessage(`Cannot delete "${productName}". Database connection failed.`, 'error'); 
                return; 
            }
            
            console.log(`Attempting to delete product: ${productId}`);

            try {
                // NOTE: This is NOT secure. A malicious user can bypass this.
                // REAL security requires Firestore Rules to check if auth.uid == doc.data.farmerId
                console.warn("Attempting insecure delete. Firestore Rules MUST be implemented for security.");
                const productDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'products', productId);
                await deleteDoc(productDocRef);
                // FIX: Use 'success' for successful deletion
                showMessage(`Listing "${productName}" successfully deleted.`, 'success'); 
            } catch (e) {
                console.error("Failed to delete document:", e);
                showMessage(`Error deleting listing. Check console/Firestore Rules.`, 'error');
            }
        }

        // --- NEW: Farmer Order Management (Mockup) ---
        function setupFarmerOrdersListener() {
            if (!db) {
                if(noFarmerOrdersMessage) noFarmerOrdersMessage.textContent = "Cannot load orders: Running in local mock mode.";
                return;
            }
            
            // This is the core problem. The current database structure
            // /artifacts/{appId}/users/{userId}/orders
            // silos orders by USER. A farmer cannot easily find all orders
            // for THEIR products without querying every single user's 'orders' collection.
            
            // This is NOT scalable or secure.
            // A production-ready fix requires changing the data structure, e.g.,
            // 1. A root 'orders' collection where each order doc has a 'farmerId'.
            // 2. When a farmer logs in, we query: query(collection(db, 'orders'), where('farmerId', '==', currentUserId))
            
            // Since I cannot change the 'checkout' function's save location without
            // a major refactor, I will add a warning message here.
            const errorMsg = "Farmer order history is not available. This feature requires a database-level change to query all orders. (Current structure silos orders by customer).";
            console.error(errorMsg);
            if(noFarmerOrdersMessage) noFarmerOrdersMessage.innerHTML = `
                <p style="text-align: center; color: var(--color-danger); padding: 3rem; background: #fff1f2; border: 1px dashed var(--color-danger); border-radius: 0.5rem;">
                    <strong>Feature Not Implemented</strong><br>
                    This feature requires a different database structure to allow farmers to see orders from all customers.
                </p>`;
            
            // Mock data for UI demo:
            const mockFarmerOrders = [
                { id: 'mock1', name: 'Organic Tomatoes', quantity: 2, unit: 'kg', price: 50.00, customerId: 'cust...123', status: 'Processing' },
                { id: 'mock2', name: 'Fresh Spinach', quantity: 3, unit: 'bundle', price: 30.00, customerId: 'cust...456', status: 'Processing' }
            ];
            renderFarmerOrders(mockFarmerOrders);
        }
        
        // NEW: Render function for farmer's received orders
        function renderFarmerOrders(orders) {
            if (!farmerOrdersList) return;
            
            // This check will be overridden by the mock data unless it's empty
            if (orders.length === 0) {
                if(noFarmerOrdersMessage) noFarmerOrdersMessage.style.display = 'block';
                farmerOrdersList.innerHTML = ''; // Clear list
            } else {
                if(noFarmerOrdersMessage) noFarmerOrdersMessage.style.display = 'none';
                
                const html = orders.map(item => `
                    <div class="farmer-order-item-card">
                        <div class="farmer-order-item-header">
                            <h4>${item.name} (x${item.quantity} ${item.unit})</h4>
                            <span class="order-status processing">${item.status}</span>
                        </div>
                        <div class="farmer-order-item-details">
                            <p><strong>Total Value:</strong> ‚Çπ${(item.price * item.quantity).toFixed(2)}</p>
                            <p><strong>Customer ID:</strong> ${item.customerId}</p>
                        </div>
                        <!-- Add buttons for 'Mark as Shipped' etc. here -->
                    </div>
                `).join('');
                farmerOrdersList.innerHTML = html;
            }
        }

        
        // --- CART/ORDER LOGIC ---
        function calculateCartTotals() {
            const subtotal = cart.reduce((sum, item) => sum + (parseFloat(item.product.price) * item.quantity), 0);
            const taxRate = 0.05; 
            const tax = subtotal * taxRate;
            const grandTotal = subtotal + tax;
            return { subtotal, tax, grandTotal };
        }

        function renderCartPage() { 
             if (!cartItemsList) return; 
            updateCartCount();
            const totals = calculateCartTotals();
            
             if (cart.length === 0) { 
                 cartItemsList.innerHTML = `<p class="empty-cart-message">Your basket is currently empty.</p>`;
                 if(checkoutBtn) { checkoutBtn.disabled = true; checkoutBtn.style.opacity = 0.6; }
             } else { 
                 if(checkoutBtn) { checkoutBtn.disabled = false; checkoutBtn.style.opacity = 1; }
                
                const html = cart.map((item, index) => {
                    const product = item.product;
                    const itemTotalPrice = (parseFloat(product.price) * item.quantity).toFixed(2);
                    return `
                        <div class="cart-item">
                            <div class="item-details">
                                <img src="${product.image}" alt="${product.name}" 
                                     onerror="this.onerror=null;this.src='https://via.placeholder.com/60x60/e0ffec/37a552?text=Item';">
                            </div>
                            <p class="item-name-unit">${product.name}<br><small>(${product.unit})</small></p>
                            <p class="item-price">‚Çπ${itemTotalPrice}</p>
                            <div class="quantity-controls">
                                <button onclick="updateCartQuantity('${product.id}', -1)" class="quantity-btn">-</button>
                                <span class="quantity-display">${item.quantity}</span>
                                <button onclick="updateCartQuantity('${product.id}', 1)" class="quantity-btn">+</button>
                            </div>
                            <button onclick="removeFromCart(${index})" class="remove-btn" title="Remove Item">&times;</button>
                        </div>
                    `;
                }).join('');
                
                cartItemsList.innerHTML = `
                    <div class="cart-item" style="font-weight: 700; border-bottom: 2px solid var(--color-primary-dark); padding-bottom: 0.5rem; margin-bottom: 0.5rem; grid-template-columns: auto 1fr auto auto auto;">
                        <p>Item</p><p>Product</p><p>Total Price</p><p>Quantity</p><p>Remove</p>
                    </div>
                    ${html}
                `;
             }
             if(cartSubtotalDisplay) cartSubtotalDisplay.textContent = `‚Çπ${totals.subtotal.toFixed(2)}`;
             if(cartTaxDisplay) cartTaxDisplay.textContent = `‚Çπ${totals.tax.toFixed(2)}`;
             if(cartGrandTotalDisplay) cartGrandTotalDisplay.textContent = `‚Çπ${totals.grandTotal.toFixed(2)}`;
        }
        
        // MODIFIED: Uses product.farmerId
        async function checkout() { 
            if (cart.length === 0) { return; }
            const totals = calculateCartTotals();
            
            const orderDetails = {
                userId: currentUserId,
                items: cart.map(item => ({ 
                    id: item.product.id, 
                    name: item.product.name, 
                    price: item.product.price, 
                    unit: item.product.unit, 
                    quantity: item.quantity,
                    farmerId: item.product.farmerId, // FIX: Use raw farmerId
                    image: item.product.image 
                })),
                subtotal: totals.subtotal.toFixed(2), 
                tax: totals.tax.toFixed(2), 
                grandTotal: totals.grandTotal.toFixed(2),
                status: 'Processing', 
                orderDate: new Date().toISOString(),
                deliveryDate: new Date(Date.now() + 3 * 24 * 60 * 60 * 1000).toISOString() 
            };
            
            if (db) { 
                 try {
                     const ordersCollectionRef = collection(db, 'artifacts', appId, 'users', currentUserId, 'orders');
                     await addDoc(ordersCollectionRef, orderDetails);
                     showMessage('Order placed successfully! Check your order history.', 'success');
                 } catch (e) {
                     console.error("Error saving order:", e);
                     showMessage('Failed to place order. Please try again.', 'error');
                 }
             } else { 
                 showMessage('Order Placed (Mock Mode - Not Saved)', 'success');
             }
            
            cart = [];
            updateCartCount();
            toggleCustomerView('market');
        }
        
        function updateCartCount() { 
            const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
            if (cartCounter) cartCounter.textContent = totalItems;
        }

        // --- ORDER HISTORY LOGIC ---
        function setupOrderListener() {
             if (!db) { 
                if(noOrdersMessage) noOrdersMessage.innerHTML = "Cannot load order history: Running in local mock mode.";
                return; 
            }
            const ordersCollectionRef = collection(db, 'artifacts', appId, 'users', currentUserId, 'orders');
            onSnapshot(ordersCollectionRef, (snapshot) => { 
                const fetchedOrders = [];
                snapshot.forEach(doc => {
                    fetchedOrders.push({ id: doc.id, ...doc.data() });
                });
                orders = fetchedOrders.sort((a, b) => new Date(b.orderDate).getTime() - new Date(a.orderDate).getTime());
                renderOrders();
             }, 
            (error) => { 
                 console.error("Error listening to orders:", error);
                 if(noOrdersMessage) noOrdersMessage.innerHTML = "Error loading order history. (Check Permissions)";
             });
        }
        
        function renderOrders() {
             if (!ordersList) return; 
             if (orders.length === 0) { 
                 if(noOrdersMessage) ordersList.innerHTML = `<p id="noOrdersMessage" style="text-align: center; color: #4b5563; padding: 3rem;">
                            You haven't placed any orders yet. Start shopping!
                        </p>`;
             } else { 
                const html = orders.map(order => {
                    const orderDate = new Date(order.orderDate).toLocaleDateString();
                    const deliveryDate = new Date(order.deliveryDate).toLocaleDateString();
                    
                    let statusClass = 'processing';
                    if (order.status === 'Delivered') statusClass = 'delivered';
                    if (order.status === 'Cancelled') statusClass = 'cancelled';
                    
                    const deliveryInfo = order.status === 'Delivered' 
                        ? `<span class="order-delivery">Delivered on: ${deliveryDate}</span>` 
                        : (order.status === 'Cancelled' ? `<span class="order-delivery">Order Cancelled</span>` : `<span class="order-delivery">Est. Delivery: ${deliveryDate}</span>`); 
                        
                    const itemList = order.items.map(item => `<p>${item.name} (Qty: ${item.quantity} x ‚Çπ${item.price} / ${item.unit})</p>`).join('');
                    
                    const cancelButton = order.status === 'Processing' 
                        ? `<div class="order-card-footer">
                               <button onclick="cancelOrder('${order.id}')" class="cancel-order-btn">Cancel Order</button>
                           </div>` 
                        : '';
                        
                    return `
                     <div class="order-card">
                        <div class="order-header-card">
                            <span class="order-id">Order ID: ${order.id.substring(0, 8)}...</span>
                            <span class="order-status ${statusClass}">${order.status}</span> 
                        </div>
                        <div class="order-details-summary">
                            <span class="order-total">Total: ‚Çπ${order.grandTotal}</span>
                            ${deliveryInfo}
                        </div>
                        <p style="font-size: 0.8rem; color: #6b7280; margin-top: 0.5rem;">Ordered on: ${orderDate}</p>
                        <div class="order-item-list">
                            <p style="font-weight: 700; color: #1f2937;">Items Purchased:</p>
                            ${itemList}
                        </div>
                        ${cancelButton} 
                    </div>
                    `; 
                }).join('');
                ordersList.innerHTML = html;
             }
        }
        
        async function cancelOrder(orderId) {
             if (!db) { showMessage("Cannot cancel order. Database connection failed.", 'error'); return; }
             if (!currentUserId) { showMessage("User not logged in.", 'error'); return; }

            console.log(`Attempting to cancel order: ${orderId}`);
            try {
                const orderDocRef = doc(db, 'artifacts', appId, 'users', currentUserId, 'orders', orderId);
                await updateDoc(orderDocRef, {
                    status: 'Cancelled' 
                });
                showMessage(`Order ${orderId.substring(0, 8)}... has been cancelled.`, 'success');
            } catch (e) {
                console.error("Error cancelling order:", e);
                showMessage("Failed to cancel the order. Please try again.", 'error');
            }
        }


        // --- Utility for API calls with Exponential Backoff (Gemini) ---
        async function retryFetch(url, options = {}, retries = 0) {
            const maxRetries = MAX_RETRIES;
            const delay = Math.pow(2, retries) * 1000 + Math.random() * 1000; 
            try {
                // FIX: Add check for empty API key
                if (apiKey === "" && isHostedEnvironment) {
                    console.log("[API] Using environment-provided API key.");
                    // The key is injected by the environment, proceed.
                } else if (apiKey === "") {
                    throw new Error("Gemini API key is not set.");
                }

                const response = await fetch(url, options);
                if (!response.ok) {
                    if (response.status === 429 && retries < maxRetries) { 
                        console.warn(`[API] Rate limited. Retrying in ${delay}ms... (Attempt ${retries + 1})`);
                        await new Promise(resolve => setTimeout(resolve, delay));
                        return retryFetch(url, options, retries + 1);
                    }
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return await response.json();
            } catch (error) {
                if (retries < maxRetries) {
                    console.warn(`[API] Fetch error. Retrying in ${delay}ms... (Attempt ${retries + 1})`);
                    await new Promise(resolve => setTimeout(resolve, delay));
                    return retryFetch(url, options, retries + 1);
                }
                console.error(`[API] Fetch failed after ${maxRetries} attempts:`, error);
                throw error;
            }
        }
        
        // --- LLM Modal Functions (Generic for all LLM outputs) ---
        function showLLMModal(title, isLoading = true) {
            llmModalTitle.innerHTML = `<span style="margin-right: 0.5rem;">‚ú®</span> ${title}`;
            llmOutput.innerHTML = ''; // Clear previous output
            
            if (isLoading) {
                llmLoading.style.display = 'flex';
            } else {
                llmLoading.style.display = 'none';
            }
            
            llmModal.style.display = 'flex';
            setTimeout(() => {
                llmContent.style.transform = 'scale(1)';
                llmContent.style.opacity = '1';
            }, 50);
        }

        function closeLLMModal() {
            llmContent.style.transform = 'scale(0.95)';
            llmContent.style.opacity = '0';
            setTimeout(() => { llmModal.style.display = 'none'; }, 300);
        }
        
        function markdownToHtml(markdownText) {
            return String(markdownText || '')
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>') 
                .replace(/^(?:\*|\-) (.*?)(?:\n|$)/gm, '<li>$1</li>') 
                .replace(/(\<li\>.*?\<\/li\>)/gs, '<ul>$1</ul>') 
                .replace(/\n/g, '<br>'); 
        }
        
        // --- CHAT BOT LOGIC ---
        let isChatOpen = false;
        function toggleChat() { 
            isChatOpen = !isChatOpen;
            chatWindow.classList.toggle('open', isChatOpen);
         }

        function renderMessage(text, sender) {
            const messageEl = document.createElement('div');
            messageEl.classList.add('chat-message', `${sender}-message`);
            messageEl.innerHTML = `<p>${markdownToHtmlChat(text)}</p>`;
            chatMessages.appendChild(messageEl);
            chatMessages.scrollTop = chatMessages.scrollHeight; // Auto-scroll
        }
        
        function renderLoadingMessage() {
            const loadingEl = document.createElement('div');
            loadingEl.classList.add('chat-message', 'gemini-message');
            loadingEl.id = 'chatLoading';
            loadingEl.innerHTML = `<p style="display: flex; align-items: center;"><span class="chat-spinner"></span> Thinking...</p>`;
            chatMessages.appendChild(loadingEl);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function removeLoadingMessage() {
            const loadingEl = document.getElementById('chatLoading');
            if (loadingEl) {
                loadingEl.remove();
            }
        }
        
        function markdownToHtmlChat(text) {
            let safeText = String(text || ''); 
            return safeText
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>') 
                .replace(/^(?:\*|\-) (.*?)(?:\n|$)/gm, '<li>$1</li>') 
                .replace(/(\<li\>.*?\<\/li\>)/gs, '<ul style="padding-left: 1.2rem; margin-top: 0.5rem;">$1</ul>') 
                .replace(/\n/g, '<br>'); 
        }
        
        async function sendMessage() {
            const message = chatInput.value.trim();
            if (!message) return;

            // FIX: Check for empty string key
            if (apiKey === "" && !isHostedEnvironment) { 
                renderMessage("The AI chatbot is not configured. (Missing API Key).", "gemini");
                return;
            }

            renderMessage(message, 'user');
            chatInput.value = '';
            renderLoadingMessage();

            chatHistory.push({ role: "user", parts: [{ text: message }] });

            const systemPrompt = currentUserRole === 'farmer' 
                ? `You are the KisanConnect Farm Business AI. Your goal is to help the farmer maximize their sales, improve product quality, and manage their listings. Your tone is helpful, professional, and advisory. Context: The user is a farmer using the KisanConnect app. Keep responses concise.`
                : `You are the KisanConnect Customer AI. Your goal is to help the customer find the best produce, get recipe ideas, and understand product freshness. Your tone is friendly, enthusiastic, and helpful. Context: The user is a customer using the KisanConnect app. Keep responses concise.`;

            const payload = {
                contents: chatHistory, 
                systemInstruction: { parts: [{ text: systemPrompt }] }
            };

            try {
                const response = await retryFetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                removeLoadingMessage();
                const generatedText = response.candidates?.[0]?.content?.parts?.[0]?.text || "I'm sorry, I couldn't process that request.";
                renderMessage(generatedText, 'gemini');
                
                chatHistory.push({ role: "model", parts: [{ text: generatedText }] });

            } catch (error) {
                removeLoadingMessage();
                console.error("Gemini Chat Error:", error);
                renderMessage("Sorry, I'm having trouble connecting to the AI service right now. Please check your API key and network connection.", 'gemini');
            }
        }
        
        // --- Global Access for HTML Buttons ---
        window.showLoginForm = showLoginForm; 
        window.handleLoginSubmit = handleLoginSubmit; 
        window.closeLoginForm = closeLoginForm;
        window.switchAuthTab = switchAuthTab; // NEW
        window.handleRegisterSubmit = handleRegisterSubmit; // NEW
        window.closeMessage = closeMessage; 
        window.closeLLMModal = closeLLMModal;
        window.optimizeListing = optimizeListing; 
        window.addToCart = addToCart;
        window.addProduct = addProduct;
        window.updatePriceValue = updatePriceValue;
        window.filterAndSortProducts = filterAndSortProducts;
        window.deleteProduct = deleteProduct; 
        window.toggleCustomerView = toggleCustomerView; 
        window.toggleFarmerView = toggleFarmerView; // NEW
        window.removeFromCart = removeFromCart; 
        window.checkout = checkout; 
        window.createProductCardHTML = createProductCardHTML; 
        window.signOutUser = signOutUser; 
        window.showLocationModal = showLocationModal;
        window.autoDetectLocation = autoDetectLocation;
        window.manualSetLocation = manualSetLocation;
        window.closeLocationModal = closeLocationModal;
        window.toggleChat = toggleChat; 
        window.sendMessage = sendMessage; 
        window.showEditProductModal = showEditProductModal; 
        window.handleUpdateProduct = handleUpdateProduct; 
        window.closeEditProductModal = closeEditProductModal; 
        window.updateCartQuantity = updateCartQuantity; 
        window.debouncedFilterAndSort = debouncedFilterAndSort; 
        window.cancelOrder = cancelOrder; 

        // --- Initialization on Load ---
        window.onload = initApp;
    </script>

</body>
</html>

